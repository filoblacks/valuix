<!doctype html>
<!--
  Solidified Calcs – Changelog sintetico
  - Valuta: rerender istantaneo e formattazione coerente con Intl.NumberFormat.
  - Validazioni: validate(input) + pannello avvisi persistente.
  - Tooltips: icone "?" su campi chiave e sui KPI normalizzati.
  - Winsor info: tooltip range per EV/EBITDA, Margin, CAGR, ND/EBITDA, CashConv, ROIC.
  - Outlier notes: EV/EBITDA>25x, Margin<0, ND/EBITDA>5x con classi .warn/.bad.
  -->
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Valuix</title>
  <meta name="description" content="Private Equity deal screener: 5 pillars, solid KPIs, sector presets, export reports. Fully client-side.">
  <meta property="og:title" content="PE Deal Screener – 5 pillars, advanced KPIs, sector presets">
  <meta property="og:description" content="Private Equity deal screener: 5 pillars, solid KPIs, sector presets, export reports. Fully client-side.">
  <meta property="og:type" content="website">
  <link href="https://fonts.googleapis.com/css2?family=Sora:wght@600;700;800&display=swap" rel="stylesheet">
  <link rel="icon" href="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 120 120'><defs><linearGradient id='gradValuix' x1='0' y1='0' x2='1' y2='1'><stop offset='0' stop-color='%2360A5FA'/><stop offset='1' stop-color='%2334D399'/></linearGradient></defs><rect x='0' y='0' width='120' height='120' rx='28' fill='black'/><rect x='22' y='22' width='32' height='32' rx='8' fill='url(%23gradValuix)'/><rect x='66' y='22' width='32' height='32' rx='8' fill='url(%23gradValuix)'/><rect x='22' y='66' width='32' height='32' rx='8' fill='url(%23gradValuix)'/><rect x='66' y='66' width='32' height='32' rx='8' fill='url(%23gradValuix)'/></svg>">
  <style>
    :root{--bg:#0b0f14; --panel:#121821; --panel-2:#0f1520; --muted:#9fb0c3; --text:#e8f0f7; --accent:#7cc0ff; --ok:#2ecc71; --warn:#f1c40f; --bad:#e74c3c; --br:16px}
    /* Palette light */
    :root { --light-bg:#f7f9fc; --light-panel:#ffffff; --light-panel-2:#f1f5fb; --light-text:#0b1220; --light-muted:#42536a; --light-border:#d7e2f0; --light-accent:#1f6fff; --light-ok:#12805a; --light-warn:#b88700; --light-bad:#c0392b; }
    /* Mapping quando attivo Light */
    body.theme-light{ --bg:var(--light-bg); --panel:var(--light-panel); --panel-2:var(--light-panel-2); --text:var(--light-text); --muted:var(--light-muted); --accent:var(--light-accent); --ok:var(--light-ok); --warn:var(--light-warn); --bad:var(--light-bad); --border:var(--light-border); }
    /* Offsets sticky header/subnav/topnav (fallback, aggiornati via JS) */
    :root{ --h-header: 56px; --h-subnav: 44px; --h-topnav: 48px; }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,var(--bg),#0a111a);color:var(--text);font:14px/1.5 system-ui,Segoe UI,Roboto,Helvetica,Arial}
    header{position:sticky;top:var(--h-topnav);background:rgba(10,16,24,.8);backdrop-filter:blur(6px);border-bottom:1px solid var(--border,#1a2330);z-index:5}
    .wrap{max-width:1200px;margin:auto;padding:18px}
    h1{font-size:20px;margin:0}
    .grid{display:grid;gap:14px}
    .two{grid-template-columns:1fr 2fr}
    .card{background:var(--panel);border:1px solid var(--border,#1a2330);border-radius:var(--br);padding:14px}
    .card.kpi-card{min-width:420px}
    .card h2{margin:0 0 8px;font-size:16px;color:#d7e6f5}
    label{display:block;font-size:12px;color:var(--muted);margin:10px 0 6px}
    input,select,textarea{width:100%;padding:10px;border-radius:10px;background:var(--panel-2);color:var(--text);border:1px solid #1b2533;outline:none}
    input:focus,select:focus,textarea:focus{border-color:#2b85ff;box-shadow:0 0 0 3px rgba(44,130,255,.15)}
    .row{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
    .row-3{grid-template-columns:repeat(3,1fr)}
    .row-2{grid-template-columns:repeat(2,1fr)}
    .btns{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
    button{background:#1f2a3b;color:#eaf3ff;border:1px solid #2a3a52;border-radius:12px;padding:10px 14px;cursor:pointer}
    button#print, #btnPrint{background:linear-gradient(90deg, #6ee7b7, #60a5fa);color:#0b1120;border:0;padding:12px 18px;font-weight:600;font-size:14px}
    button.primary{background:#2563eb;border-color:#2b6be0}
    button.ghost{background:transparent}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid var(--border,#1a2330);text-align:right}
    th:first-child,td:first-child{text-align:left}
    .kpi{display:grid;gap:12px}
    .kpi-top{grid-template-columns:repeat(4,minmax(0,1fr));margin-bottom:8px}
    .kpi-grid{grid-template-columns:repeat(5,minmax(0,1fr))}
    .kpi .i{background:var(--panel-2);border:1px solid var(--border,#1a2330);border-radius:12px;padding:10px}
    .kpi .v{font-size:18px;font-weight:700}
    .tag{padding:3px 8px;border-radius:999px;border:1px solid #2b3b52;color:#cfe2ff;background:#0d1420;display:inline-block;font-size:12px}
    .scorebar{height:10px;background:#172133;border-radius:999px;overflow:hidden}
    .scorebar>span{display:block;height:100%;background:linear-gradient(90deg,#6ee7b7,#60a5fa);width:0%}
    .note{font-size:12px;color:#a7b7c8}
    .footer{margin-top:18px;display:flex;gap:10px;align-items:center;justify-content:space-between}
    .pillars{display:grid;grid-template-columns:repeat(5,1fr);gap:10px}
    .mini{font-size:12px;color:#a7b7c8}
    @media (max-width:1100px){.pillars{grid-template-columns:1fr 1fr}.kpi-top{grid-template-columns:repeat(2,1fr)}.kpi-grid{grid-template-columns:repeat(2,1fr)}.two{grid-template-columns:1fr}}
    @media (max-width:640px){.pillars{grid-template-columns:1fr}.row,.row-3,.row-2{grid-template-columns:1fr}}
    /* Solidified Calcs: helpers & alerts */
    .help{display:inline-flex;align-items:center;justify-content:center;width:16px;height:16px;margin-left:6px;border-radius:50%;background:#1f2a3b;border:1px solid #2a3a52;color:#cfe2ff;font-size:11px;cursor:help}
    .alert{padding:10px;border-radius:12px;background:#0e141e;border:1px solid var(--border,#1a2330)}
    .alert.ok{border-color:rgba(46,204,113,.4);color:var(--ok)}
    .alert.warn{border-color:rgba(241,196,15,.4);color:var(--warn)}
    .alert h3{margin:0 0 6px;font-size:13px;color:#d7e6f5}
    .alert ul{margin:0;padding-left:18px}
    .warn{color:var(--warn)}
    .bad{color:var(--bad)}
    /* Sector Preset */
    .sliders{display:grid;grid-template-columns:1fr;gap:10px}
    .sliderRow{display:grid;grid-template-columns:200px 1fr 56px;gap:10px;align-items:center}
    .sliderRow input[type=range]{width:100%}
    .sliderVal{display:inline-block;min-width:56px;text-align:right;color:#cfe2ff}
    .presetBar{display:flex;gap:10px;align-items:center;margin-bottom:8px}
    .presetInfo{margin-top:6px}
    /* Pillar breakdown */
    .pb-row { display:flex; align-items:center; gap:10px; margin:6px 0; }
    .pb-label { width:140px; min-width:120px; color:#cfe2ff; font-size:13px }
    .pb-bar { position:relative; flex:1; height:10px; background:#172133; border-radius:999px; overflow:hidden }
    .pb-fill { position:absolute; left:0; top:0; bottom:0; width:0% ;
      background:linear-gradient(90deg,#6ee7b7,#60a5fa) }
    .pb-meta { width:140px; min-width:120px; text-align:right; color:#a7b7c8; font-size:12px }
    @media (max-width:640px){
      .pb-row { flex-wrap:wrap }
      .pb-label, .pb-meta { width:100%; text-align:left }
    }
    /* Subnav sticky */
    .subnav{ position:sticky; top:calc(var(--h-topnav) + var(--h-header)); z-index:6; display:flex; gap:12px; padding:10px 18px; background:rgba(10,16,24,.7); backdrop-filter:blur(6px); border-bottom:1px solid var(--border,#1a2330); }
    body.theme-light .subnav{ background:rgba(255,255,255,.75); }
    .subnav a{ color:var(--muted); text-decoration:none; padding:6px 10px; border-radius:999px }
    .subnav a.active{ color:var(--text); background:var(--panel-2); border:1px solid var(--border,#1a2330) }
    /* Ancore: margine quando si atterra su una sezione */
    :target{ scroll-margin-top: calc(var(--h-topnav) + var(--h-header) + var(--h-subnav) + 12px); }
    /* Scroll globale per anchor click */
    html{ scroll-behavior:smooth; scroll-padding-top: calc(var(--h-topnav) + var(--h-header) + var(--h-subnav) + 12px); }

    /* ===== Marketing/Landing ===== */
    /* Marketing nav */
    .marketing-nav{ position:sticky; top:0; z-index:7; background:var(--panel); border-bottom:1px solid var(--border,#1a2330); }
    .marketing-nav .wrap{ display:flex; align-items:center; justify-content:space-between; padding:10px 18px; }
    .marketing-nav .brand{ font-weight:800; letter-spacing:.2px }
    .marketing-nav a{ color:var(--text); text-decoration:none; margin:0 10px; padding:6px 10px; border-radius:999px }
    .marketing-nav a.active{ background:var(--panel-2); border:1px solid var(--border,#1a2330); }
    .marketing-nav .right{ display:flex; align-items:center; gap:8px; flex-wrap:wrap }

    /* Brand pill */
    .brand{
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      padding: 0;
      border: 0;
      background: transparent;
      box-shadow: none;
      gap: 0;
      transition: transform .15s ease;
    }
    .brand::after{
      content: none;
    }
    .brand:hover{ transform: translateY(-1px); }
    .brand:focus-visible{
      outline: none;
      box-shadow: none;
    }

    /* Logo sizing */
    .brand svg{ display:block; height:42px; width:auto }

    /* Evita pill/contorno quando il brand diventa active per l'highlight della sezione */
    .marketing-nav .brand.active{ background: transparent; border: 0 }

    /* Header spacing & alignment (se serve) */
    header .wrap{ display:flex; align-items:center; justify-content:space-between; gap:16px }
    nav .menu a{
      color:#cfe2ff; text-decoration:none; padding:10px 12px; border-radius:10px;
      transition: background .15s ease, color .15s ease;
    }
    nav .menu a:hover{ background:#0f1520 }
    nav .menu a[aria-current="page"]{
      color: var(--accent);
      background: rgba(124,192,255,.10);
      border: 1px solid rgba(124,192,255,.22);
    }

    /* Light theme adjustments */
    body.theme-light .brand{
      color:inherit;
      border-color: transparent;
      background: transparent;
      box-shadow: none;
    }
    body.theme-light nav .menu a{ color:#1f2a3b }
    body.theme-light nav .menu a:hover{ background:#eef4ff }
    body.theme-light nav .menu a[aria-current="page"]{
      color:#2563eb; background: #e8f1ff; border-color: #cfe2ff;
    }

    .section{ padding:56px 0; }

    .features{ display:grid; grid-template-columns:repeat(3,1fr); gap:12px }
    .feature{ background:var(--panel); border:1px solid var(--border,#1a2330); border-radius:16px; padding:14px }
    .feature .t{ font-weight:700; margin:6px 0 }
    .feature .i{ font-size:18px; }
    .steps{ display:grid; grid-template-columns:repeat(3,1fr); gap:12px }
    .step{ background:var(--panel); border:1px solid var(--border,#1a2330); border-radius:16px; padding:14px; text-align:center }

    .faq details{ background:var(--panel); border:1px solid var(--border,#1a2330); border-radius:16px; padding:12px; margin:8px 0 }
    .faq summary{ cursor:pointer; font-weight:600 }

    .section-app .head{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:8px }
    .section-app .note{ font-size:12px; color:var(--muted) }

    @media(max-width:900px){ .features{ grid-template-columns:1fr } .steps{ grid-template-columns:1fr } .hero h1{ font-size:38px } }
    /* Top dashboard */
    .topdash{ display:grid; grid-template-columns:repeat(4,1fr); gap:12px; margin-bottom:8px }
    .topdash .k{ display:flex; flex-direction:column; gap:6px; align-items:flex-start }
    .topdash .k .t{ font-size:12px; color:var(--muted) }
    .topdash .k .v{ font-size:24px; font-weight:800; letter-spacing:.2px }
    .topdash .k.big .v{ font-size:28px }
    @media(max-width:900px){ .topdash{ grid-template-columns:1fr 1fr } }
    /* Report tabs */
    .tabs{ display:flex; gap:8px; margin:8px 0 12px }
    .tabs button{ padding:8px 12px; border-radius:999px; border:1px solid var(--border,#1a2330); background:var(--panel-2); color:var(--text); cursor:pointer }
    .tabs button.active{ outline:2px solid var(--accent); }
    .tabc[hidden]{ display:none !important; }
    /* Note leggibili in light */
    body.theme-light .note{ color:#4b5b74 }

    /* Hero background */
    .hero{
      position:relative;
      min-height:70vh;
      padding:200px 0 180px;
      text-align:center;
      background:
        radial-gradient(1600px 1600px at 20% 10%, rgba(124,192,255,.12), transparent 60%),
        radial-gradient(1800px 1600px at 80% 70%, rgba(110,231,183,.10), transparent 55%),
        linear-gradient(180deg, #0b0f14, #0a111a);
    }
    body.theme-light .hero{
      min-height:70vh;
      padding:200px 0 180px;
      background:
        radial-gradient(1600px 1600px at 20% 10%, rgba(31,111,255,.12), transparent 60%),
        radial-gradient(1800px 1600px at 80% 70%, rgba(110,231,183,.08), transparent 55%),
        linear-gradient(180deg, #ffffff, #f9fafb);
    }

    /* Hero text */
    .hero-text{ 
      max-width:900px; 
      margin:auto;
      position:absolute;
      top:calc(50% + var(--h-topnav, 48px));
      left:50%;
      transform:translate(-50%, -50%);
      width:100%;
      padding:0 18px;
    }

    .hero-title{
      font-size:54px;
      font-weight:800;
      color:#fff;
      margin:0 0 16px;
    }
    body.theme-light .hero-title{ color:#0b0f14; }

    .hero-sub{
      font-size:24px;
      font-weight:600;
      color:var(--accent, #60a5fa);
      margin:0 0 20px;
    }

    .hero-desc{
      font-size:16px;
      line-height:1.6;
      color:#9fb0c3;
      margin:0 auto 28px;
      max-width:720px;
    }

    /* CTA button center */
    .hero .cta{ display:flex; justify-content:center; gap:12px }

    /* Responsive hero */
    @media (max-width: 768px) {
      .hero{ padding: 80px 0 60px; }
      .hero-title{ font-size: 42px; }
      .hero-sub{ font-size: 20px; }
      .hero-desc{ font-size: 15px; max-width: 100%; }
    }
    
    @media (max-width: 480px) {
      .hero{ padding: 60px 0 40px; }
      .hero-title{ font-size: 36px; }
      .hero-sub{ font-size: 18px; }
      .hero-desc{ font-size: 14px; }
    }

    /* Buttons */
    .btn{ display:inline-flex; align-items:center; gap:8px; padding:10px 14px; border-radius:999px; border:1px solid var(--border,#2a3a52); cursor:pointer; text-decoration:none; font-weight:600 }
    .btn-primary{ background:linear-gradient(90deg, #6ee7b7, #60a5fa); color:#0b1120; border:0 }
    .btn-primary:hover{ filter:saturate(1.1) brightness(1.02) }
    .btn-ghost{ background:transparent; color:var(--text) }
    .btn-ghost:hover{ background:var(--panel-2) }

    /* ---------- How it works ---------- */
    .steps{ display:grid; grid-template-columns:repeat(3,1fr); gap:14px; margin-top:10px }
    .step{ background:var(--panel); border:1px solid var(--border,#1a2330); border-radius:18px; padding:16px; transition: transform .15s ease, box-shadow .15s ease }
    .step:hover{ transform: translateY(-2px); box-shadow:0 10px 20px rgba(0,0,0,.12) }
    .step .i{ font-size:22px; margin-bottom:6px }
    .step .t{ font-weight:700; margin-bottom:4px }
    @media (max-width:900px){ .steps{ grid-template-columns:1fr } }

    /* ---------- Features grid ---------- */
    .features{ display:grid; grid-template-columns:repeat(3,1fr); gap:12px; margin-top:10px }
    .feature{ background:var(--panel); border:1px solid var(--border,#1a2330); border-radius:16px; padding:14px; display:flex; flex-direction:column; gap:6px; min-height:120px; transition:transform .15s ease, box-shadow .15s ease }
    .feature:hover{ transform: translateY(-2px); box-shadow:0 10px 20px rgba(0,0,0,.12) }
    .feature .i{ font-size:18px; opacity:.9 }
    .feature .t{ font-weight:700 }
    @media (max-width:900px){ .features{ grid-template-columns:1fr } }

    /* ---------- Small polish ---------- */
    html{ scroll-behavior:smooth }
    .section h2{ font-size:26px; margin:0 0 10px }
    .section{ padding:56px 0 }

    /* Clean roadmap */
    .road.clean{
      margin:24px 0;
      padding:0;
      display:flex;
      flex-direction:column;
      gap:24px;
    }
    .node{ display:flex; align-items:flex-start; gap:16px; }

    /* Step number circle */
    .step-num{
      flex:0 0 38px; height:38px;
      display:flex; align-items:center; justify-content:center;
      font-weight:700; font-size:16px; color:#fff;
      background:linear-gradient(135deg,#60a5fa,#34d399);
      border-radius:50%;
      box-shadow:0 4px 12px rgba(0,0,0,.15);
    }

    /* Card */
    .node .card{
      flex:1;
      background:var(--panel);
      border:1px solid var(--border,#1a2330);
      border-radius:14px;
      padding:14px 18px;
      box-shadow:0 6px 14px rgba(0,0,0,.08);
    }
    .node .card h3{
      margin:0 0 6px;
      font-size:17px;
      font-weight:600;
      color:var(--text);
    }
    .node .card p{ margin:0 0 6px; font-size:14px; line-height:1.5; }
    .node .card .tips{ font-size:12px; color:var(--muted); display:block }

    /* Responsive */
    @media(max-width:720px){
      .node{ flex-direction:column; gap:8px }
      .step-num{ margin-bottom:4px }
    }
    /* ===== Print Report System ===== */
    /* Fuori stampa: il contenitore non è visibile e non sporca il layout */
    #printReport { display: none; }
    #printReport.print-only-active { position:static; }
    
    @media print {
      /* In stampa: nascondi tutto tranne il report */
      body > *:not(#printReport) { 
        display: none !important; 
      }
      body { 
        margin: 0 !important; 
        padding: 0 !important; 
      }
      #printReport { 
        display: block !important; 
        position: static !important;
        margin: 0 !important; 
        padding: 0 !important; 
      }

      /* Page breaks per Full Memo - SEMPRE DOPO OGNI .page tranne l'ultima */
      #printReport.mode-memo .page { 
        page-break-after: always !important; 
        break-after: page !important;
      }
      #printReport.mode-memo .page:last-child { 
        page-break-after: auto !important; 
        break-after: auto !important;
      }
      
      /* One-Pager: nessun page-break automatico */
      #printReport.mode-executive .page { 
        page-break-after: avoid !important; 
        break-after: avoid !important;
      }

      /* Evita spezzature indesiderate dentro gli elementi */
      .print-section, .print-kpi-grid,
      .print-two-col, .print-pillar-row, .print-kpi-card { 
        page-break-inside: avoid !important;
        break-inside: avoid !important; 
      }

      @page { 
        size: A4; 
        margin: 16mm; 
      }

      /* Conserva tipografia/impaginazione pregresse utili alla resa di stampa */
      #printReport {
        background: white !important;
        color: #0b1220 !important;
        font-family: 'Sora', 'Inter', system-ui, sans-serif;
        font-size: 11pt;
        line-height: 1.35;
        print-color-adjust: exact;
        -webkit-print-color-adjust: exact;
      }
      .print-header {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        height: 40px;
        background: white;
        border-bottom: 1px solid #d7e2f0;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 16mm;
        font-size: 10pt;
        font-weight: 600;
        z-index: 1000;
      }
      .print-footer {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        height: 36px;
        background: white;
        border-top: 1px solid #d7e2f0;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0 16mm;
        font-size: 9pt;
        color: #42536a;
        z-index: 1000;
      }
      /* Margini compensativi per header/footer fissi */
      .print-content { 
        margin-top: 50px !important; 
        margin-bottom: 48px !important; 
        padding: 0 !important; 
      }

      /* Executive One-Pager: layout ultra-compatto su 1 pagina */
      #printReport.mode-executive .print-content { 
        margin-top: 48px !important; 
        margin-bottom: 40px !important; 
        line-height: 1.25 !important;
      }
      #printReport.mode-executive .print-logo svg { height: 15pt; }
      #printReport.mode-executive .print-title { font-size: 18pt; margin-bottom: 4pt; line-height: 1.2; }
      #printReport.mode-executive .print-subtitle { font-size: 10pt; margin: 4pt 0 2pt; font-weight: 600; line-height: 1.2; }
      #printReport.mode-executive .print-kpi-value { font-size: 11pt; }
      #printReport.mode-executive .print-kpi-label { font-size: 9pt; }
      #printReport.mode-executive .print-section { margin: 3pt 0; }
      #printReport.mode-executive .print-scorebar { height: 10pt; margin: 2pt 0; }
      #printReport.mode-executive .print-kpi-grid { gap: 8pt; margin: 8pt 0; }
      #printReport.mode-executive .print-kpi-card { padding: 8pt; }
      #printReport.mode-executive .print-pillar-row { margin: 4pt 0; }
      #printReport.mode-executive .print-bullet { margin: 2pt 0; font-size: 10pt; line-height: 1.3; }
      #printReport.mode-executive .print-two-col { gap: 8pt; }
      #printReport.mode-executive .print-section { 
        page-break-inside: auto !important;
        break-inside: auto !important; 
      }
      
      /* Full Memo: evita break dentro le sezioni */
      #printReport.mode-memo .print-section.avoid-break { 
        page-break-inside: avoid !important;
        break-inside: avoid !important; 
      }
      #printReport.mode-memo .print-kpi-grid,
      #printReport.mode-memo .print-pillar-row { 
        page-break-inside: avoid !important;
        break-inside: avoid !important; 
      }
      
      /* Typography */
      .print-title {
        font-size: 24pt;
        font-weight: 600;
        margin: 0 0 16pt;
        color: #0b1220;
      }
      
      .print-subtitle {
        font-size: 14pt;
        font-weight: 600;
        margin: 16pt 0 8pt;
        color: #0b1220;
      }
      
      .print-section {
        margin: 12pt 0;
      }
      
      .print-table {
        width: 100%;
        border-collapse: collapse;
        margin: 8pt 0;
        font-size: 10pt;
      }
      
      .print-table th,
      .print-table td {
        padding: 6pt 8pt;
        border-bottom: 1px solid #e5edf7;
        text-align: left;
      }
      
      .print-table th {
        background: #f1f5fb;
        font-weight: 600;
        color: #0b1220;
      }
      
      .print-table td:last-child,
      .print-table th:last-child {
        text-align: right;
      }
      
      /* Score bars */
      .print-scorebar {
        height: 12pt;
        background: #f1f5fb;
        border-radius: 6pt;
        overflow: hidden;
        margin: 4pt 0;
        position: relative;
      }
      
      .print-scorebar-fill {
        height: 100%;
        background: linear-gradient(90deg, #34d399, #60a5fa);
        border-radius: 6pt;
        transition: none;
      }
      
      .print-scorebar-text {
        position: absolute;
        top: 50%;
        right: 8pt;
        transform: translateY(-50%);
        font-size: 9pt;
        font-weight: 600;
        color: #0b1220;
      }
      
      /* KPI cards for executive */
      .print-kpi-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 12pt;
        margin: 12pt 0;
      }
      
      .print-kpi-card {
        border: 1px solid #d7e2f0;
        border-radius: 8pt;
        padding: 12pt;
        background: #f9fafb;
      }
      
      .print-kpi-label {
        font-size: 9pt;
        color: #42536a;
        margin-bottom: 4pt;
        white-space: nowrap;
      }
      
      .print-kpi-value {
        font-size: 16pt;
        font-weight: 600;
        color: #0b1220;
      }
      
      /* Pillar breakdown */
      .print-pillar-row {
        display: flex;
        align-items: center;
        margin: 6pt 0;
        gap: 8pt;
      }
      
      .print-pillar-label {
        width: 100pt;
        font-size: 10pt;
        color: #0b1220;
      }
      
      .print-pillar-bar {
        flex: 1;
        height: 8pt;
        background: #f1f5fb;
        border-radius: 4pt;
        overflow: hidden;
        position: relative;
      }
      
      .print-pillar-fill {
        height: 100%;
        background: linear-gradient(90deg, #34d399, #60a5fa);
        border-radius: 4pt;
      }
      
      .print-pillar-value {
        width: 60pt;
        text-align: right;
        font-size: 9pt;
        color: #42536a;
      }
      
      /* Layout helpers */
      .print-two-col {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16pt;
      }
      
      .print-bullet {
        margin: 4pt 0;
        padding-left: 12pt;
        position: relative;
      }
      
      .print-bullet::before {
        content: "•";
        position: absolute;
        left: 0;
        color: #60a5fa;
        font-weight: bold;
      }
      
      /* Logo placeholder */
      .print-logo {
        width: 120pt;
        height: 24pt;
        display: flex;
        align-items: center;
        justify-content: flex-start;
        gap: 8pt;
      }
      
      .print-logo svg {
        height: 20pt;
        width: auto;
      }
      
      .print-logo-text {
        font-family: 'Sora', 'Inter', system-ui, sans-serif;
        font-size: 14pt;
        font-weight: 600;
        background: linear-gradient(90deg, #60a5fa, #34d399);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        color: #60a5fa; /* fallback */
      }
    }
    
    /* ===== Legacy Print Styles (keep for compatibility) ===== */
    @media print {
      .subnav{ display:none !important; }
      /* Nascondi landing marketing solo in modalità print-only-report */
      body.print-only-report .marketing-nav,
      body.print-only-report #home,
      body.print-only-report #how,
      body.print-only-report #features,
      body.print-only-report #faq,
      body.print-only-report #contact { display:none !important; }
      body.print-only-report header,
      body.print-only-report main > *:not(#reportSection) {
        display: none !important;
      }
      body.print-only-report #reportSection {
        display: block !important;
        border: none !important;
        box-shadow: none !important;
      }
      body.print-only-report .wrap { max-width: 900px !important; }

      /* Extra (opzionali) */
      body.print-only-report .note { color:#333 !important; }
      body.print-only-report #reportSection .btns,
      body.print-only-report #reportSection button { display:none !important; }
      /* Forza visibilità di tutte le tab in stampa del solo Report */
      body.print-only-report #reportSection .tabc{ display:block !important; }
      body.print-only-report #reportTabs{ display:none !important; }
    }
    /* Ensure print-only containers are rendered ONLY in print mode */
    @media print {
      .print-only { display: block !important; }
    }
  </style>
</head>
<body>
  <nav class="marketing-nav">
    <div class="wrap">
      <a href="#home" class="brand" aria-label="Valuix — Private Equity deal screener">
        <svg xmlns="http://www.w3.org/2000/svg" width="220" height="48" viewBox="0 0 220 48" aria-hidden="true" focusable="false">
          <defs>
            <linearGradient id="gradValuix" x1="0" y1="0" x2="1" y2="1">
              <stop offset="0" stop-color="#60A5FA"/>
              <stop offset="1" stop-color="#34D399"/>
            </linearGradient>
          </defs>
          <g transform="translate(0,2)">
            <rect x="0" y="0" width="40" height="40" rx="10" fill="black"/>
            <rect x="8" y="8" width="10" height="10" rx="2" fill="url(#gradValuix)"/>
            <rect x="22" y="8" width="10" height="10" rx="2" fill="url(#gradValuix)"/>
            <rect x="8" y="22" width="10" height="10" rx="2" fill="url(#gradValuix)"/>
            <rect x="22" y="22" width="10" height="10" rx="2" fill="url(#gradValuix)"/>
          </g>
          <text x="52" y="32" font-family="Sora, Inter, system-ui, sans-serif" font-size="28" font-weight="700" fill="url(#gradValuix)">Valuix</text>
        </svg>
      </a>
      <div class="right">
        <a href="#how">How it works</a>
        <a href="#features">Features</a>
        <a href="#demo" class="cta-demo">Screener</a>
        <a href="#faq">FAQ</a>
        <a href="#contact">Contact</a>
      </div>
    </div>
  </nav>

  <section id="home" class="hero section" aria-labelledby="hero-title">
    <div class="wrap hero-text">
      <h1 id="hero-title" class="hero-title">Financial analysis, simplified</h1>
      <p class="hero-sub">Evaluate any company in seconds</p>
      <p class="hero-desc">
        Sector-aware valuation, normalized KPIs, and investment-grade scoring across five pillars.
        Run entirely in your browser — transparent maths, export-ready output.
      </p>
      <div class="cta">
        <a id="btnHeroDemo" class="btn btn-primary" href="#demo">Try it now</a>
      </div>
    </div>
  </section>

  <section id="how" class="section roadmap roadmap--compact" aria-labelledby="how-title">
    <div class="wrap">
      <h2 id="how-title">How it works</h2>
      <ol class="road clean" role="list">
        <li class="node">
          <div class="step-num">1</div>
          <div class="card">
            <h3>Choose a sector preset</h3>
            <p>Select <b>Sector (preset)</b> to load industry weights and the EV/EBITDA range used for winsorization.</p>
            <span class="tips">Hover EV/EBITDA to see the sector range.</span>
          </div>
        </li>
        <li class="node">
          <div class="step-num">2</div>
          <div class="card">
            <h3>Load demo or enter data</h3>
            <p>Pick a company from <b>Load demo</b> or type your numbers. Currency follows the <b>Valuta</b> selector.</p>
            <span class="tips">Leave Market Cap empty to auto-calc <i>Price × Shares</i>.</span>
          </div>
        </li>
        <li class="node">
          <div class="step-num">3</div>
          <div class="card">
            <h3>Complete core metrics</h3>
            <p>Fill <b>Debt/Cash, EBITDA, Revenue FY & FY-3</b>; optional <b>Capex/OCF</b> (Cash Conversion), <b>NOPAT/IC</b> (ROIC).</p>
            <span class="tips">The alerts panel flags missing or invalid inputs.</span>
          </div>
        </li>
        <li class="node">
          <div class="step-num">4</div>
          <div class="card">
            <h3>Tune weights & modes</h3>
            <p>Adjust pillar weights to your mandate. Toggle <b>Take-private</b> to treat low liquidity (MC/ADV) as a bonus.</p>
            <span class="tips">Pillar breakdown shows effective weights.</span>
          </div>
        </li>
        <li class="node">
          <div class="step-num">5</div>
          <div class="card">
            <h3>Generate & review</h3>
            <p>Click <b>Generate report</b>. Review KPIs (EV/EBITDA, Margin, CAGR, ND/EBITDA, CashConv, ROIC) and pillar bars with tooltips.</p>
          </div>
        </li>
        <li class="node">
          <div class="step-num">6</div>
          <div class="card">
            <h3>Export & save</h3>
            <p>Print a clean, report-only PDF via <b>Print / PDF</b> or the hero CTA. Use <b>Save</b>/<b>Load</b> to keep your session.</p>
          </div>
        </li>
      </ol>
    </div>
  </section>

  <section id="features" class="section" aria-labelledby="feat-title">
    <div class="wrap">
      <h2 id="feat-title">Key capabilities</h2>
      <div class="features">
        <div class="feature">
          <div class="i">📊</div>
          <div class="t">Sector-aware EV/EBITDA</div>
          <div class="note">Per-industry ranges and winsorization to handle outliers without masking signal.</div>
        </div>
        <div class="feature">
          <div class="i">⚖️</div>
          <div class="t">Dynamic weights</div>
          <div class="note">Preset by industry with instant manual override; the breakdown shows effective weights.</div>
        </div>
        <div class="feature">
          <div class="i">🔒</div>
          <div class="t">Take-private mode</div>
          <div class="note">Liquidity factor (MC/ADV) flips from penalty to bonus when TP is on.</div>
        </div>
        <div class="feature">
          <div class="i">🧱</div>
          <div class="t">Solid KPIs</div>
          <div class="note">Cash Conversion and ROIC included, with explicit ranges and tooltips.</div>
        </div>
        <div class="feature">
          <div class="i">📈</div>
          <div class="t">Visual pillar breakdown</div>
          <div class="note">Accessible bars with scores and weights; hover tooltips explain the logic.</div>
        </div>
        <div class="feature">
          <div class="i">🧾</div>
          <div class="t">Export-ready</div>
          <div class="note">Print-only report section for clean PDFs; CSV export coming soon.</div>
        </div>
      </div>
    </div>
  </section>

  <section id="demo" class="section-app">
    <div class="wrap head">
    </div>

    <nav id="subnav" class="subnav">
      <a href="#section-input">Data</a>
      <a href="#section-kpi">KPI &amp; Score</a>
      <a href="#section-alerts">Alerts</a>
      <a href="#section-outliers">Outliers</a>
      <a href="#reportSection">Report</a>
    </nav>

    <main class="wrap grid two" id="app">
    <section class="card" id="section-input">
      <h2>1) Company Data</h2>
      <div class="row-3">
        <div><label>Ticker</label><input id="inTicker" placeholder="e.g. SAP.DE"/></div>
        <div><label>Name</label><input id="inName" placeholder="SAP SE"/></div>
        <div><label>Country</label><input id="inCountry" placeholder="Germany"/></div>
      </div>
      <div class="row-3">
        <div>
          <label>Sector (preset)</label>
          <select id="inSector">
            <option value="Neutrale" selected>Neutral (baseline)</option>
            <option value="SaaS">SaaS</option>
            <option value="Software non-SaaS">Software non-SaaS</option>
            <option value="Industrial / Manufacturing">Industrial / Manufacturing</option>
            <option value="Business Services (BPO, testing, facilities)">Business Services (BPO, testing, facilities)</option>
            <option value="Healthcare – Providers/Services">Healthcare – Providers/Services</option>
            <option value="Healthcare – MedTech & Diagnostics">Healthcare – MedTech & Diagnostics</option>
            <option value="Healthcare – CRO/CDMO">Healthcare – CRO/CDMO</option>
            <option value="Consumer Staples">Consumer Staples</option>
            <option value="Consumer Discretionary/Retail">Consumer Discretionary/Retail</option>
            <option value="Luxury & Premium Brands">Luxury & Premium Brands</option>
            <option value="Logistics & Transportation">Logistics & Transportation</option>
            <option value="Energy & Natural Resources (Upstream)">Energy & Natural Resources (Upstream)</option>
            <option value="Materials / Chemicals">Materials / Chemicals</option>
            <option value="Utilities / Infra-like (regolate)">Utilities / Infra-like (regolate)</option>
            <option value="Telecom">Telecom</option>
            <option value="Media & Entertainment">Media & Entertainment</option>
            <option value="FinTech / Payments">FinTech / Payments</option>
            <option value="Hardware / Semiconductors">Hardware / Semiconductors</option>
          </select>
        </div>
        <div><label>Currency</label>
          <select id="inCcy"><option>EUR</option><option>USD</option><option>GBP</option><option>CHF</option></select>
        </div>
        <div><label>Beta (opt.)</label><input id="inBeta" type="number" step="0.01" placeholder="e.g. 1.05"/></div>
      </div>
      <div class="row-3">
        <div><label>Price per share</label><input id="inPrice" type="number" step="0.0001" placeholder="e.g. 140.50"/></div>
        <div><label>Shares (diluted) outstanding</label><input id="inShares" type="number" step="1" placeholder="e.g. 1180000000"/></div>
        <div><label>Market Cap (if you want to force)</label><input id="inMktCap" type="number" step="0.01" placeholder="leave empty for price×shares"/></div>
      </div>
      <div class="row-3">
        <div><label>Total Debt</label><input id="inDebt" type="number" step="0.01" placeholder="e.g. 18000000000"/></div>
        <div><label>Cash & Equivalents</label><input id="inCash" type="number" step="0.01" placeholder="e.g. 6000000000"/></div>
        <div><label>ADV 60d (local currency) (opt.)</label><input id="inADV" type="number" step="0.01" placeholder="average traded value"/></div>
      </div>
      <!-- Take-private: toggle UI -->
      <div class="row-2">
        <div></div>
        <div style="display:flex;align-items:center;gap:6px;margin-top:20px">
          <input type="checkbox" id="takePrivateToggle" />
          <label for="takePrivateToggle">Take-private Mode</label>
          <span class="help" title="In take-private mode, low ADV is considered an advantage (easier to acquire).">?</span>
        </div>
      </div>
      <div class="row">
        <div><label>Revenue FY-3</label><input id="rev3" type="number" step="0.01"/></div>
        <div><label>Revenue FY-2</label><input id="rev2" type="number" step="0.01"/></div>
        <div><label>Revenue FY-1</label><input id="rev1" type="number" step="0.01"/></div>
        <div><label>Revenue FY (latest) <span class="help" title="Used for EBITDA margin and 3Y CAGR.">?</span></label><input id="rev0" type="number" step="0.01"/></div>
      </div>
      <div class="row-2">
        <div><label>EBITDA (latest FY) <span class="help" title="Must be > 0 to calculate multiples and leverage (EV/EBITDA, ND/EBITDA)">?</span></label><input id="ebitda" type="number" step="0.01"/></div>
        <div><label>Latest FY Year</label><input id="fyYear" type="number" step="1" placeholder="e.g. 2024"/></div>
      </div>
      <div class="row-3">
        <div><label>Capex (latest FY)</label><input id="capex" type="number" step="0.01"/></div>
        <div><label>Operating Cash Flow (FY)</label><input id="ocf" type="number" step="0.01"/></div>
        <div><label>NOPAT (FY)</label><input id="nopat" type="number" step="0.01"/></div>
      </div>
      <div class="row-2">
        <div><label>Invested Capital <span class="help" title="Used for ROIC (NOPAT/IC). If IC ≤ 0 ROIC is not calculable.">?</span></label><input id="invCap" type="number" step="0.01"/></div>
      </div>

      <h2 style="margin-top:12px">2) Scoring Parameters</h2>
      <div class="pillars">
        <div>
          <label>Value Weight (EV/EBITDA ↓)</label>
          <input id="wValue" type="number" step="0.05" value="0.25"/>
        </div>
        <div>
          <label>Quality Weight (EBITDA% ↑)</label>
          <input id="wQuality" type="number" step="0.05" value="0.20"/>
        </div>
        <div>
          <label>Growth Weight (Rev CAGR 3Y ↑)</label>
          <input id="wGrowth" type="number" step="0.05" value="0.20"/>
        </div>
        <div>
          <label>Leverage & Cash Weight</label>
          <input id="wLev" type="number" step="0.05" value="0.20"/>
          <div class="mini">Uses Net Debt/EBITDA ↓ and Cash/Debt ↑</div>
        </div>
        <div>
          <label>Strategic Fit Weight</label>
          <input id="wStrat" type="number" step="0.05" value="0.15"/>
          <div class="mini">Sector/Country fit (0–1)</div>
        </div>
        <div>
          <label>Cash Conversion Weight</label>
          <input id="wCash" type="number" step="0.05" value="0.10"/>
          <div class="mini">FCF/EBITDA ↑</div>
        </div>
        <div>
          <label>ROIC Weight</label>
          <input id="wROIC" type="number" step="0.05" value="0.10"/>
          <div class="mini">NOPAT/Invested Capital ↑</div>
        </div>
        <!-- Take-private: new Liquidity (ADV) weight -->
        <div>
          <label>Liquidity (ADV) Weight</label>
          <input id="wADV" type="number" step="0.05" value="0.10"/>
          <div class="mini">MC/ADV</div>
        </div>
      </div>

      <div class="row-3" style="margin-top:8px">
        <div><label>Strategic Fit – Sector (0–1)</label><input id="fitSector" type="number" min="0" max="1" step="0.05" value="0.8"/></div>
        <div><label>Strategic Fit – Country (0–1)</label><input id="fitCountry" type="number" min="0" max="1" step="0.05" value="0.8"/></div>
        <div><label>Liquidity Penalty: ADV60d threshold (ccy)</label><input id="liqThresh" type="number" step="0.01" value="2000000"/></div>
      </div>
      <div class="row-3">
        <div><label>Penalty (0–1) if below threshold</label><input id="liqPen" type="number" step="0.05" value="0.15"/></div>
        <div><label>Deal size min (Market Cap)</label><input id="sizeMin" type="number" step="0.01" placeholder="e.g. 1e8"/></div>
        <div><label>Deal size max (Market Cap)</label><input id="sizeMax" type="number" step="0.01" placeholder="e.g. 5e9"/></div>
      </div>
      <!-- Value: sector-aware via dropdown -->
      <div class="note">Normalizations: EV/EBITDA [sector-aware], EBITDA% [-50%–80%], CAGR [0%–40%], NetDebt/EBITDA [0–6], Cash/Debt [0–1.5], Cash Conversion [0–1], ROIC [0–20%], MC/ADV [0–200]. Out of range → winsorized.</div>

      <!-- Demo dropdown -->
      <div class="row-3">
        <div>
          <label>Load demo</label>
          <select id="demoSelect">
            <option value="">— Select demo company —</option>
            <!-- options will be populated by JS at runtime -->
          </select>
        </div>
      </div>

      <div class="btns">
        <button class="primary" id="btnCalc">Generate report</button>
        <button id="btnSave" class="ghost">Save</button>
        <button id="btnLoad" class="ghost">Load</button>
      </div>
      <div class="note">Numbers are expected in the <b>selected currency</b>. Leave empty fields that are not available.</div>
    </section>

    

    <section class="card kpi-card" id="section-kpi">
      <h2>3) KPI & Score</h2>

      <!-- TOP ROW: highlights -->
      <div id="kpiTop" class="kpi kpi-top">
        <div class="i"><div class="t">Score</div><div class="v" id="kScoreText">—</div></div>
        <div class="i"><div class="t">EV/EBITDA</div><div class="v" id="kTopEVEBITDA">—</div></div>
        <div class="i"><div class="t">EBITDA Margin</div><div class="v" id="kTopMargin">—</div></div>
        <div class="i"><div class="t">ROIC</div><div class="v" id="kTopROIC">—</div></div>
      </div>

      <!-- SECOND ROW: only non-duplicated KPIs -->
      <div id="kpiGrid" class="kpi kpi-grid">
        <div class="i"><div class="t">Enterprise Value</div><div class="v" id="kEV">—</div><div class="tag" id="kCcy">—</div></div>
        <div class="i"><div class="t">Rev CAGR 3Y</div><div class="v" id="kCAGR">—</div></div>
        <div class="i"><div class="t">Net Debt / EBITDA</div><div class="v" id="kNDebtE">—</div></div>
        <div class="i"><div class="t">Cash Conversion</div><div class="v" id="kCashConv">—</div></div>
        <div class="i"><div class="t">Liquidity (MC/ADV)</div><div class="v" id="kMCADV">—</div></div>
      </div>
      <div style="margin-top:12px">
        <div class="t">Overall Score</div>
        <div class="scorebar"><span id="scoreBar"></span></div>
        <div class="note" id="scoreNote">—</div>
      </div>
      <!-- Pillar breakdown -->
      <div class="note" style="margin-top:8px"><b>Pillar breakdown</b></div>
      <div id="pillarBreakdown"></div>
    </section>

    <!-- Solidified Calcs: persistent alerts panel -->
    <section class="card" id="section-alerts" style="grid-column:1 / -1">
      <h2>Alerts & Validation</h2>
      <div id="alertsPanel" class="alert ok">
        <h3>Status</h3>
        <ul id="alertsList"><li>No issues detected.</li></ul>
      </div>
    </section>

    <!-- Solidified Calcs: outlier box -->
    <section class="card" id="section-outliers" style="grid-column:1 / -1">
      <h2>Outlier Notes</h2>
      <div id="outliersBox" class="note">—</div>
    </section>

    <section class="card" id="reportSection" style="grid-column:1 / -1">
      <h2>4) Report</h2>
      
      <!-- Print Report Selection -->
      <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;padding:10px;background:var(--panel-2);border-radius:8px;">
        <label style="font-weight:600;color:var(--text);margin:0;">Modalità Stampa:</label>
        <div style="display:flex;gap:8px;">
          <label style="display:flex;align-items:center;gap:4px;margin:0;cursor:pointer;">
            <input type="radio" name="printMode" value="executive" checked style="width:auto;">
            <span>Executive One-Pager</span>
          </label>
          <label style="display:flex;align-items:center;gap:4px;margin:0;cursor:pointer;">
            <input type="radio" name="printMode" value="fullmemo" style="width:auto;">
            <span>Full Memo</span>
          </label>
        </div>
      </div>
      
      <div class="tabs" id="reportTabs">
        <button data-tab="tabExec" class="active">Executive</button>
        <button data-tab="tabKPI">KPI</button>
        <button data-tab="tabPillars">Pillars</button>
        <button data-tab="tabDetails">Details</button>
      </div>
      <div id="tabExec" class="tabc"></div>
      <div id="tabKPI" class="tabc" hidden></div>
      <div id="tabPillars" class="tabc" hidden></div>
      <div id="tabDetails" class="tabc" hidden></div>
      <div class="footer">
        <span class="note" id="stamp">—</span>
        <div class="btns"><button id="btnPrint">Print / PDF</button></div>
      </div>
    </section>
    </main>
  </section>

  <section id="faq" class="section faq">
    <div class="wrap">
      <h2>FAQ</h2>
      <details>
        <summary>Does data stay local?</summary>
        <div class="note">Yes, everything client-side; no data sent to server.</div>
      </details>
      <details>
        <summary>Can I change the weights?</summary>
        <div class="note">Yes, by sector or manually; the breakdown shows effective weights.</div>
      </details>
      <details>
        <summary>EV/EBITDA for Luxury is high: how do you handle it?</summary>
        <div class="note">Sector-aware range and winsorization; optional soft tail or alternative metrics.</div>
      </details>
      <details>
        <summary>Take-private mode?</summary>
        <div class="note">Low ADV becomes a bonus; dedicated liquidity KPI.</div>
      </details>
      <details>
        <summary>Can I use USD/GBP?</summary>
        <div class="note">Yes, currency selector with consistent formatting.</div>
      </details>
    </div>
  </section>

  <footer id="contact" class="section">
    <div class="wrap" style="display:flex;align-items:center;justify-content:space-between;gap:12px">
      <div class="note">This tool is experimental; it does not constitute investment advice.</div>
      <div class="btns">
        <a href="mailto:canepanerifilippo@gmail.com" class="tag" style="text-decoration:none">Email</a>
        <a href="https://www.linkedin.com/in/filippo-canepa-neri/" target="_blank" rel="noopener" class="tag" style="text-decoration:none">LinkedIn</a>
      </div>
      <div class="note">© 2025 · v0.1</div>
    </div>
  </footer>

  <!-- Hidden Print Report Container -->
  <section id="printReport" class="print-only" aria-hidden="true"></section>

<script>
// ---------- Utils ----------
const fmt = (n, ccy) => (n==null||!isFinite(n)) ? '—' : new Intl.NumberFormat('it-IT',{style: ccy?'currency':'decimal', currency: ccy||'EUR', maximumFractionDigits: ccy?0:2}).format(n);
const pct = (n) => (n==null||!isFinite(n)) ? '—' : (n*100).toFixed(1)+'%';
const clamp = (x, a, b) => Math.min(Math.max(x, a), b);
const winsor = (x, lo, hi) => x==null?null: clamp(x, lo, hi);
const byId = (id)=>document.getElementById(id);

// ---------- Global state for unified calculations ----------
let gLast = { input: null, output: null, score: null };

// ---------- Light/Dark Theme ----------
function applyTheme(t){ document.body.classList.toggle('theme-light', t==='light'); const b=byId('btnTheme'); if(b) b.textContent = (t==='light'?'Dark':'Light'); localStorage.setItem('pe-theme', t); setStickyVars(); }
function initTheme(){ const t = localStorage.getItem('pe-theme') || 'dark'; applyTheme(t); }

// Sticky offsets: dynamically calculate header/subnav
function setStickyVars(){
  const t = document.querySelector('.marketing-nav');
  const h = document.querySelector('header');
  const n = document.getElementById('subnav');
  const th = t ? Math.ceil(t.getBoundingClientRect().height) : 48;
  const hh = h ? Math.ceil(h.getBoundingClientRect().height) : 56;
  const nh = n ? Math.ceil(n.getBoundingClientRect().height) : 44;
  document.documentElement.style.setProperty('--h-topnav', th + 'px');
  document.documentElement.style.setProperty('--h-header', hh + 'px');
  document.documentElement.style.setProperty('--h-subnav', nh + 'px');
}

// ---------- Print helpers ----------
function printReportOnly(){
  const printMode = document.querySelector('input[name="printMode"]:checked')?.value || 'executive';
  
  // Build and populate the print report
  if (gLast && gLast.input && gLast.output && gLast.score) {
    buildPrintReport(gLast, printMode);
  } else {
    // Fallback to legacy print if no data
    document.body.classList.add('print-only-report');
    const clear = () => document.body.classList.remove('print-only-report');
    if ('onafterprint' in window) {
      const prev = window.onafterprint;
      window.onafterprint = function(){
        clear();
        if (typeof prev === 'function') prev();
        window.onafterprint = prev || null;
      };
    } else {
      setTimeout(clear, 1000);
    }
    window.print();
    return;
  }
  
  // Print the professional report
  window.print();
}

// ---------- Professional Print Report System ----------
function buildPrintReport(gLast, mode = 'executive') {
  const { input, output, score } = gLast;
  const container = document.getElementById('printReport');
  if (!container) return;
  
  const now = new Date();
  const dateTime = now.toLocaleString('it-IT', { 
    day: '2-digit', 
    month: '2-digit', 
    year: 'numeric', 
    hour: '2-digit', 
    minute: '2-digit' 
  });
  
  if (mode === 'executive') {
    container.classList.add('mode-executive');
    container.classList.remove('mode-memo');
    container.innerHTML = buildExecutiveOnePager(input, output, score, dateTime);
  } else {
    container.classList.add('mode-memo');
    container.classList.remove('mode-executive');
    container.innerHTML = buildFullMemo(input, output, score, dateTime);
  }
  if(!container.innerHTML.trim()){
    throw new Error('Empty report HTML');
  }
}

function buildExecutiveOnePager(input, output, score, dateTime) {
  const companyName = input.name || input.ticker || 'N/A';
  const scoreValue = score.score == null ? 0 : Math.round(score.score * 100);
  const takePrivateStatus = input.takePrivate ? 'ON' : 'OFF';
  
  // Get core KPIs (6-8 as specified)
  const coreKPIs = [
    { label: 'EV/EBITDA', value: output.evE == null ? '—' : output.evE.toFixed(2) + '×', highlight: true },
    { label: 'EBITDA Margin', value: formatPct(output.margin), highlight: true },
    { label: 'Rev CAGR 3Y', value: formatPct(output.cagr), highlight: false },
    { label: 'Net Debt/EBITDA', value: output.ndE == null ? '—' : output.ndE.toFixed(2) + '×', highlight: false },
    { label: 'Cash Conversion', value: formatPct(output.cashConv), highlight: false },
    { label: 'ROIC', value: formatPct(output.roic), highlight: true }
  ];
  
  // Add liquidity if available
  if (output.mc > 0 && input.adv > 0) {
    const mcadv = (output.mc / input.adv).toFixed(1) + '×';
    coreKPIs.push({ label: 'Liquidity (MC/ADV)', value: mcadv, highlight: false });
  }
  
  // Pillar breakdown from score.breakdown
  const pillars = (score.breakdown || []).slice(0, 8).map(p => ({
    name: p.k,
    score: Math.round(p.s * 100),
    weight: Math.round(p.w * 100)
  }));
  
  // Generate investment highlights
  const highlights = generateInvestmentHighlights(input, output, score);
  
  return `
    <div class="print-header">
      <div class="print-logo">
        <svg xmlns="http://www.w3.org/2000/svg" height="20" viewBox="0 0 40 40" aria-hidden="true" focusable="false">
          <defs>
            <linearGradient id="gradValuixPrint" x1="0" y1="0" x2="1" y2="1">
              <stop offset="0" stop-color="#60A5FA"/>
              <stop offset="1" stop-color="#34D399"/>
            </linearGradient>
          </defs>
          <rect x="0" y="0" width="40" height="40" rx="10" fill="black"/>
          <rect x="8" y="8" width="10" height="10" rx="2" fill="url(#gradValuixPrint)"/>
          <rect x="22" y="8" width="10" height="10" rx="2" fill="url(#gradValuixPrint)"/>
          <rect x="8" y="22" width="10" height="10" rx="2" fill="url(#gradValuixPrint)"/>
          <rect x="22" y="22" width="10" height="10" rx="2" fill="url(#gradValuixPrint)"/>
        </svg>
        <span class="print-logo-text">Valuix</span>
      </div>
      <div>Executive Summary</div>
    </div>
    
    <div class="print-footer">
      Valuix · Generated on ${dateTime}
    </div>
    
    <div class="print-content">
      <!-- Header Section -->
      <div class="avoid-break">
        <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:8pt;">
          <div>
            <h1 class="print-title">${companyName}</h1>
            <div style="font-size:11pt;color:#42536a;margin-bottom:6pt;">
              ${input.ticker || '—'} · ${input.country || '—'} · ${input.sector || '—'} · ${input.ccy}
            </div>
          </div>
          <div style="text-align:right;">
            <div style="font-size:9pt;color:#42536a;">Overall Score</div>
            <div style="font-size:18pt;font-weight:600;color:#0b1220;margin:3pt 0;">${scoreValue}/100</div>
            <div style="font-size:9pt;color:#42536a;">Take-private: ${takePrivateStatus}</div>
          </div>
        </div>
        
        <!-- Overall Score Bar -->
        <div class="print-scorebar avoid-break">
          <div class="print-scorebar-fill" style="width:${scoreValue}%"></div>
          <div class="print-scorebar-text">${scoreValue}/100</div>
        </div>
      </div>
      
      <!-- Core KPIs Grid -->
      <div class="print-section avoid-break">
        <h2 class="print-subtitle">Key Performance Indicators</h2>
        <div class="print-kpi-grid">
          ${coreKPIs.slice(0, 6).map(kpi => `
            <div class="print-kpi-card">
              <div class="print-kpi-label">${kpi.label}</div>
              <div class="print-kpi-value">${kpi.value}</div>
            </div>
          `).join('')}
        </div>
      </div>
      
      <!-- Pillar Breakdown -->
      <div class="print-section avoid-break">
        <h2 class="print-subtitle">Pillar Breakdown</h2>
        ${pillars.map(pillar => `
          <div class="print-pillar-row">
            <div class="print-pillar-label">${pillar.name}</div>
            <div class="print-pillar-bar">
              <div class="print-pillar-fill" style="width:${pillar.score}%"></div>
            </div>
            <div class="print-pillar-value">${pillar.score}/100 (${pillar.weight}%)</div>
          </div>
        `).join('')}
      </div>
      
      <!-- Mandate Fit -->
      <div class="print-section avoid-break">
        <h2 class="print-subtitle">Mandate Fit</h2>
        <div class="print-two-col">
          <div>
            <div style="font-size:9pt;color:#42536a;margin-bottom:2pt;">Deal Size</div>
            <div style="font-size:11pt;font-weight:600;">
              ${formatMoney(input.size.min, input.ccy)} - ${formatMoney(input.size.max, input.ccy)}
            </div>
            <div style="font-size:9pt;color:#42536a;margin-top:2pt;">
              Current: ${formatMoney(output.mc, input.ccy)}
              ${score.sizeFlag ? ' (Outside mandate)' : ' ✓'}
            </div>
          </div>
          <div>
            <div style="font-size:9pt;color:#42536a;margin-bottom:2pt;">Liquidity</div>
            <div style="font-size:11pt;font-weight:600;">
              ADV: ${formatMoney(input.adv, input.ccy)}
            </div>
            <div style="font-size:9pt;color:#42536a;margin-top:2pt;">
              ${score.penalty ? 'Below threshold' : 'Adequate liquidity'} 
              ${input.takePrivate ? '(TP mode: bonus)' : ''}
            </div>
          </div>
        </div>
      </div>
      
      <!-- Investment Rationale -->
      <div class="print-section avoid-break">
        <h2 class="print-subtitle">Investment Rationale</h2>
        ${highlights.map(highlight => `
          <div class="print-bullet">${highlight}</div>
        `).join('')}
      </div>
      
    </div>
  `;
}

function buildFullMemo(input, output, score, dateTime) {
  const companyName = input.name || input.ticker || 'N/A';
  const scoreValue = score.score == null ? 0 : Math.round(score.score * 100);
  
  return `
    <div class="print-header">
      <div class="print-logo">
        <svg xmlns="http://www.w3.org/2000/svg" height="20" viewBox="0 0 40 40" aria-hidden="true" focusable="false">
          <defs>
            <linearGradient id="gradValuixPrintMemo" x1="0" y1="0" x2="1" y2="1">
              <stop offset="0" stop-color="#60A5FA"/>
              <stop offset="1" stop-color="#34D399"/>
            </linearGradient>
          </defs>
          <rect x="0" y="0" width="40" height="40" rx="10" fill="black"/>
          <rect x="8" y="8" width="10" height="10" rx="2" fill="url(#gradValuixPrintMemo)"/>
          <rect x="22" y="8" width="10" height="10" rx="2" fill="url(#gradValuixPrintMemo)"/>
          <rect x="8" y="22" width="10" height="10" rx="2" fill="url(#gradValuixPrintMemo)"/>
          <rect x="22" y="22" width="10" height="10" rx="2" fill="url(#gradValuixPrintMemo)"/>
        </svg>
        <span class="print-logo-text">Valuix</span>
      </div>
      <div>Investment Memo</div>
    </div>
    
    <div class="print-footer">
      Valuix · Generated on ${dateTime} · Page <span id="pageNum">1</span>/<span id="totalPages">4</span>
    </div>
    
    <div class="print-content">
      <!-- Cover Page -->
      <div class="page">
        <div style="text-align:center;margin-top:40pt;">
          <div class="print-logo" style="margin:0 auto 24pt;justify-content:center;">
            <svg xmlns="http://www.w3.org/2000/svg" height="32" viewBox="0 0 40 40" aria-hidden="true" focusable="false">
              <defs>
                <linearGradient id="gradValuixCover" x1="0" y1="0" x2="1" y2="1">
                  <stop offset="0" stop-color="#60A5FA"/>
                  <stop offset="1" stop-color="#34D399"/>
                </linearGradient>
              </defs>
              <rect x="0" y="0" width="40" height="40" rx="10" fill="black"/>
              <rect x="8" y="8" width="10" height="10" rx="2" fill="url(#gradValuixCover)"/>
              <rect x="22" y="8" width="10" height="10" rx="2" fill="url(#gradValuixCover)"/>
              <rect x="8" y="22" width="10" height="10" rx="2" fill="url(#gradValuixCover)"/>
              <rect x="22" y="22" width="10" height="10" rx="2" fill="url(#gradValuixCover)"/>
            </svg>
            <span class="print-logo-text" style="font-size:18pt;">Valuix</span>
          </div>
          <h1 class="print-title" style="font-size:28pt;margin-bottom:16pt;">${companyName}</h1>
          <div style="font-size:16pt;color:#42536a;margin-bottom:8pt;">${input.sector || 'N/A'}</div>
          <div style="font-size:14pt;color:#42536a;margin-bottom:24pt;">${input.ticker || '—'} · ${input.country || '—'}</div>
          
          <div style="display:inline-block;padding:16pt 24pt;border:2px solid #60a5fa;border-radius:12pt;background:#f9fafb;">
            <div style="font-size:12pt;color:#42536a;margin-bottom:4pt;">Overall Score</div>
            <div style="font-size:32pt;font-weight:600;color:#0b1220;">${scoreValue}/100</div>
          </div>
        </div>
      </div>
      
      <!-- Executive Summary -->
      <div class="page">
        <h1 class="print-title">Executive Summary</h1>
        
        <!-- KPI Cards -->
        <div class="print-section avoid-break">
          <h2 class="print-subtitle">Key Metrics</h2>
          <div class="print-kpi-grid">
            <div class="print-kpi-card">
              <div class="print-kpi-label">Enterprise Value</div>
              <div class="print-kpi-value">${formatMoney(output.ev, input.ccy)}</div>
            </div>
            <div class="print-kpi-card">
              <div class="print-kpi-label">EV/EBITDA</div>
              <div class="print-kpi-value">${output.evE == null ? '—' : output.evE.toFixed(2) + '×'}</div>
            </div>
            <div class="print-kpi-card">
              <div class="print-kpi-label">EBITDA Margin</div>
              <div class="print-kpi-value">${formatPct(output.margin)}</div>
            </div>
            <div class="print-kpi-card">
              <div class="print-kpi-label">Revenue CAGR 3Y</div>
              <div class="print-kpi-value">${formatPct(output.cagr)}</div>
            </div>
            <div class="print-kpi-card">
              <div class="print-kpi-label">Net Debt/EBITDA</div>
              <div class="print-kpi-value">${output.ndE == null ? '—' : output.ndE.toFixed(2) + '×'}</div>
            </div>
            <div class="print-kpi-card">
              <div class="print-kpi-label">ROIC</div>
              <div class="print-kpi-value">${formatPct(output.roic)}</div>
            </div>
          </div>
        </div>
        
        <!-- Pillar Breakdown -->
        <div class="print-section avoid-break">
          <h2 class="print-subtitle">Pillar Breakdown</h2>
          ${(score.breakdown || []).map(p => `
            <div class="print-pillar-row">
              <div class="print-pillar-label">${p.k}</div>
              <div class="print-pillar-bar">
                <div class="print-pillar-fill" style="width:${Math.round(p.s * 100)}%"></div>
              </div>
              <div class="print-pillar-value">${Math.round(p.s * 100)}/100 (${Math.round(p.w * 100)}%)</div>
            </div>
          `).join('')}
        </div>
        
        <!-- Investment Highlights -->
        <div class="print-section avoid-break">
          <h2 class="print-subtitle">Investment Highlights</h2>
          ${generateInvestmentHighlights(input, output, score).map(highlight => `
            <div class="print-bullet">${highlight}</div>
          `).join('')}
        </div>
      </div>
      
      <!-- Financial Snapshot -->
      <div class="page">
        <h1 class="print-title">Financial Snapshot</h1>
        
        <table class="print-table">
          <thead>
            <tr>
              <th>Metric</th>
              <th>Value</th>
              <th>Multiple/Ratio</th>
            </tr>
          </thead>
          <tbody>
            <tr><td>Market Cap</td><td>${formatMoney(output.mc, input.ccy)}</td><td>—</td></tr>
            <tr><td>Enterprise Value</td><td>${formatMoney(output.ev, input.ccy)}</td><td>—</td></tr>
            <tr><td>Total Debt</td><td>${formatMoney(input.debt, input.ccy)}</td><td>—</td></tr>
            <tr><td>Cash & Equivalents</td><td>${formatMoney(input.cash, input.ccy)}</td><td>—</td></tr>
            <tr><td>Revenue (FY)</td><td>${formatMoney(input.rev[0], input.ccy)}</td><td>—</td></tr>
            <tr><td>Revenue (FY-3)</td><td>${formatMoney(input.rev[3], input.ccy)}</td><td>CAGR: ${formatPct(output.cagr)}</td></tr>
            <tr><td>EBITDA</td><td>${formatMoney(input.ebitda, input.ccy)}</td><td>EV/EBITDA: ${output.evE == null ? '—' : output.evE.toFixed(2) + '×'}</td></tr>
            <tr><td>EBITDA Margin</td><td>${formatPct(output.margin)}</td><td>—</td></tr>
            <tr><td>Capex</td><td>${formatMoney(input.capex, input.ccy)}</td><td>—</td></tr>
            <tr><td>Operating Cash Flow</td><td>${formatMoney(input.ocf, input.ccy)}</td><td>—</td></tr>
            <tr><td>NOPAT</td><td>${formatMoney(input.nopat, input.ccy)}</td><td>—</td></tr>
            <tr><td>Invested Capital</td><td>${formatMoney(input.invCap, input.ccy)}</td><td>ROIC: ${formatPct(output.roic)}</td></tr>
          </tbody>
        </table>
      </div>
      
      <!-- Methodology & Appendix -->
      <div class="page">
        <h1 class="print-title">Methodology</h1>
        
        <div class="print-section avoid-break">
          <h2 class="print-subtitle">Sector Weights</h2>
          <p style="font-size:10pt;line-height:1.4;">
            Sector: ${input.sector}. Pillar weights are optimized for this industry vertical based on value driver analysis and historical performance patterns.
          </p>
        </div>
        
        <div class="print-section avoid-break">
          <h2 class="print-subtitle">Winsorization Ranges</h2>
          <ul style="font-size:10pt;line-height:1.4;margin:0;padding-left:16pt;">
            <li><strong>EV/EBITDA:</strong> Sector-aware (${input.sector} range varies)</li>
            <li><strong>EBITDA Margin:</strong> -50% to 80%</li>
            <li><strong>Revenue Growth:</strong> 0% to 40%</li>
            <li><strong>Net Debt/EBITDA:</strong> 0 to 6×</li>
            <li><strong>Cash Conversion:</strong> 0 to 1 (FCF/EBITDA)</li>
            <li><strong>ROIC:</strong> 0% to 20%</li>
          </ul>
        </div>
        
        <div class="print-section avoid-break">
          <h2 class="print-subtitle">Take-Private Mode</h2>
          <p style="font-size:10pt;line-height:1.4;">
            Current setting: <strong>${input.takePrivate ? 'ON' : 'OFF'}</strong>. 
            ${input.takePrivate ? 
              'Low liquidity (MC/ADV) treated as acquisition advantage.' : 
              'Low liquidity penalized per traditional public markets approach.'
            }
          </p>
        </div>
        
        <div class="print-section avoid-break">
          <h2 class="print-subtitle">Deal Size & Liquidity Rules</h2>
          <p style="font-size:10pt;line-height:1.4;">
            Target range: ${formatMoney(input.size.min, input.ccy)} - ${formatMoney(input.size.max, input.ccy)} market cap.
            Liquidity threshold: ${formatMoney(input.liq.thresh, input.ccy)} ADV 60d.
            Current company ${score.sizeFlag ? 'outside' : 'within'} mandate size.
          </p>
        </div>
        
        <div class="print-section" style="margin-top:24pt;padding-top:12pt;border-top:1px solid #d7e2f0;">
          <h2 class="print-subtitle">Appendix</h2>
          <p style="font-size:9pt;color:#42536a;line-height:1.4;">
            <strong>Demo Dataset Note:</strong> This tool includes representative demo companies for testing and calibration purposes.<br>
            <strong>Tool Version:</strong> Valuix v0.1 - Professional PE Deal Screener<br>
            <strong>Disclaimer:</strong> This analysis is for informational purposes only and does not constitute investment advice.
          </p>
        </div>
      </div>
    </div>
  `;
}

function generateInvestmentHighlights(input, output, score) {
  const highlights = [];
  
  // Why interesting
  if (score.score > 0.7) {
    highlights.push("Strong overall score indicating attractive investment profile across multiple value drivers");
  } else if (score.score > 0.5) {
    highlights.push("Solid fundamentals with identified opportunities for value creation");
  }
  
  if (output.evE && output.evE < 15) {
    highlights.push("Attractive valuation multiple relative to sector benchmarks");
  }
  
  if (output.cagr && output.cagr > 0.1) {
    highlights.push("Demonstrated growth trajectory with 3-year revenue CAGR exceeding 10%");
  }
  
  if (output.roic && output.roic > 0.15) {
    highlights.push("High-quality business model evidenced by strong return on invested capital");
  }
  
  // Key risks
  if (output.ndE && output.ndE > 4) {
    highlights.push("Risk: Elevated leverage requiring attention to debt management and cash flow");
  }
  
  if (score.penalty) {
    highlights.push("Risk: Limited liquidity may impact exit optionality and execution timeline");
  }
  
  if (score.sizeFlag) {
    highlights.push("Note: Deal size outside current mandate parameters");
  }
  
  // Fallback if no specific highlights
  if (highlights.length === 0) {
    highlights.push("Investment case requires deeper evaluation of sector dynamics and competitive positioning");
    highlights.push("Financial profile presents mixed signals warranting enhanced due diligence");
    highlights.push("Sector-specific considerations may drive ultimate investment decision");
  }
  
  return highlights.slice(0, 4); // Max 4 bullets as specified
}

// --- DEMO DATASET (updated) ---
const DEMO = [
  // Industrials
  {
    ticker:"AIR.PA", name:"Airbus", country:"France", sector:"Industrial / Manufacturing",
    price:140, shares:790000000,
    debt:15000000000, cash:10000000000,
    ebitda:8500000000, rev0:65000000000, rev3:49000000000,
    capex:2800000000, ocf:7000000000,
    nopat:4800000000, invCap:50000000000,
    adv:250000000
  },
  {
    ticker:"SU.PA", name:"Schneider Electric", country:"France", sector:"Industrial / Manufacturing",
    price:170, shares:600000000,
    debt:18000000000, cash:7000000000,
    ebitda:9500000000, rev0:36000000000, rev3:29000000000,
    capex:1200000000, ocf:8500000000,
    nopat:5600000000, invCap:42000000000,
    adv:220000000
  },

  // Consumer Staples
  {
    ticker:"HEIA.AS", name:"Heineken", country:"Netherlands", sector:"Consumer Staples",
    price:95, shares:570000000,
    debt:17000000000, cash:4000000000,
    ebitda:6500000000, rev0:31000000000, rev3:28000000000,
    capex:1800000000, ocf:5600000000,
    nopat:3200000000, invCap:36000000000,
    adv:180000000
  },
  {
    ticker:"BN.PA", name:"Danone", country:"France", sector:"Consumer Staples",
    price:60, shares:640000000,
    debt:13000000000, cash:3000000000,
    ebitda:3600000000, rev0:27400000000, rev3:24700000000,
    capex:1000000000, ocf:7000000000,
    nopat:2350000000, invCap:35000000000,
    adv:80000000
  },

  // Healthcare / MedTech
  {
    ticker:"SHL.DE", name:"Siemens Healthineers", country:"Germany", sector:"Healthcare – MedTech & Diagnostics",
    price:45, shares:1120000000,
    debt:18000000000, cash:5000000000,
    ebitda:7000000000, rev0:21000000000, rev3:19000000000,
    capex:1500000000, ocf:6400000000,
    nopat:2900000000, invCap:33000000000,
    adv:150000000
  },
  {
    ticker:"AFX.XE", name:"Carl Zeiss Meditec", country:"Germany", sector:"Healthcare – MedTech & Diagnostics",
    price:110, shares:90000000,
    debt:1500000000, cash:1200000000,
    ebitda:700000000, rev0:2200000000, rev3:1800000000,
    capex:200000000, ocf:600000000,
    nopat:420000000, invCap:3500000000,
    adv:50000000
  },

  // FinTech / Payments
  {
    ticker:"EDEN.PA", name:"Edenred", country:"France", sector:"FinTech / Payments",
    price:55, shares:250000000,
    debt:5000000000, cash:1500000000,
    ebitda:1200000000, rev0:2800000000, rev3:2000000000,
    capex:300000000, ocf:1000000000,
    nopat:800000000, invCap:7000000000,
    adv:60000000
  },
  {
    ticker:"TEMN.SW", name:"Temenos", country:"Switzerland", sector:"Software non-SaaS",
    price:65, shares:75000000,
    debt:2300000000, cash:500000000,
    ebitda:600000000, rev0:1000000000, rev3:900000000,
    capex:100000000, ocf:550000000,
    nopat:400000000, invCap:3500000000,
    adv:40000000
  },

  // Consumer Discretionary / Retail
  {
    ticker:"ITX.MC", name:"Inditex (Zara)", country:"Spain", sector:"Consumer Discretionary/Retail",
    price:45, shares:3100000000,
    debt:7000000000, cash:9000000000,
    ebitda:9000000000, rev0:36000000000, rev3:28000000000,
    capex:1500000000, ocf:10000000000,
    nopat:5000000000, invCap:45000000000,
    adv:200000000
  },

  // Utilities / Infra-like
  {
    ticker:"ENEL.MI", name:"Enel", country:"Italy", sector:"Utilities / Infra-like (regolate)",
    price:6, shares:10000000000,
    debt:64000000000, cash:15000000000,
    ebitda:22000000000, rev0:90000000000, rev3:77000000000,
    capex:14000000000, ocf:18000000000,
    nopat:6000000000, invCap:120000000000,
    adv:300000000
  }
];


// <!-- Value: sector-aware via dropdown -->
function mapSectorAliasToDropdownLabel(s){
  const x = (s||'').toLowerCase();
  if (x==='software') return 'Software non-SaaS';
  if (x==='fintech/payments') return 'FinTech / Payments';
  if (x==='industrial') return 'Industrial / Manufacturing';
  if (x==='business services') return 'Business Services (BPO, testing, facilities)';
  if (x==='healthcare') return 'Healthcare – Providers/Services';
  if (x==='logistics') return 'Logistics & Transportation';
  if (x==='energy/natural resources') return 'Energy & Natural Resources (Upstream)';
  if (x==='materials/chemicals') return 'Materials / Chemicals';
  if (x==='consumer discretionary') return 'Consumer Discretionary/Retail';
  // extra alias per demo
  if (x==='semiconductors') return 'Hardware / Semiconductors';
  // altrimenti restituisce l'originale (già conforme)
  return s;
}

// <!-- Demo dataset: fill & dropdown wiring -->
function fillInputsFrom(item){
  const set=(id,val)=>{ const el=byId(id); if(el) el.value = (val ?? ''); };
  set('inTicker', item.ticker);
  set('inName', item.name);
  set('inCountry', item.country);
  // <!-- Value: sector-aware via dropdown -->
  set('inSector', mapSectorAliasToDropdownLabel(item.sector));
  set('inPrice', item.price);
  set('inShares', item.shares);
  set('inDebt', item.debt);
  set('inCash', item.cash);
  set('ebitda', item.ebitda);
  set('rev0', item.rev0);
  set('rev3', item.rev3);
  // opzionali
  set('rev1', item.rev1 ?? '');
  set('rev2', item.rev2 ?? '');
  set('capex', item.capex);
  set('ocf', item.ocf);
  set('nopat', item.nopat);
  set('invCap', item.invCap);
  set('inADV', item.adv);
}

function initDemoDropdown(){
  const sel = byId('demoSelect');
  if(!sel) return;
  // opzioni
  DEMO.forEach((d, idx)=>{
    const opt=document.createElement('option');
    opt.value=String(idx);
    opt.textContent=`${d.name} (${d.ticker})`;
    sel.appendChild(opt);
  });
  // handler
  sel.addEventListener('change', ()=>{
    if(sel.value==='') return;
    const item = DEMO[Number(sel.value)];
    fillInputsFrom(item);

    // Forza il preset del settore della società demo selezionata
    const sector = byId('inSector').value;
    applyPreset(sector, { source: 'demo', force: true });

    const I = collectInput();
    const O = computeAll(I);
    const S = score(O, I);
    gLast = { input: I, output: O, score: S };
    renderKPI(O, I, S);
    renderReport(O, I, S);
    renderAlerts(validate(I));
    saveState();
  });
}

// <!-- Sector Preset: configurations and rationale -->
const WEIGHT_PRESETS = {
  'Neutrale': { value:15, quality:15, growth:15, lev:15, strat:10, cash:15, roic:15 },
  'SaaS': { value:10, quality:20, growth:25, lev:10, strat:10, cash:10, roic:15 },
  'Software non-SaaS': { value:12, quality:20, growth:20, lev:10, strat:10, cash:15, roic:13 },
  'Industrial / Manufacturing': { value:25, quality:15, growth:10, lev:20, strat:10, cash:10, roic:10 },
  'Business Services (BPO, testing, facilities)': { value:15, quality:20, growth:15, lev:10, strat:10, cash:15, roic:15 },
  'Healthcare – Providers/Services': { value:15, quality:22, growth:15, lev:10, strat:10, cash:10, roic:18 },
  'Healthcare – MedTech & Diagnostics': { value:12, quality:20, growth:20, lev:8, strat:10, cash:10, roic:20 },
  'Healthcare – CRO/CDMO': { value:12, quality:18, growth:20, lev:10, strat:10, cash:12, roic:18 },
  'Consumer Staples': { value:18, quality:20, growth:8, lev:10, strat:11, cash:18, roic:15 },
  'Consumer Discretionary/Retail': { value:20, quality:15, growth:15, lev:15, strat:10, cash:15, roic:10 },
  'Luxury & Premium Brands': { value:20, quality:15, growth:15, lev:15, strat:10, cash:15, roic:10 },
  'Logistics & Transportation': { value:22, quality:10, growth:10, lev:18, strat:10, cash:18, roic:12 },
  'Energy & Natural Resources (Upstream)': { value:25, quality:8, growth:10, lev:20, strat:15, cash:12, roic:10 },
  'Materials / Chemicals': { value:22, quality:12, growth:10, lev:15, strat:15, cash:12, roic:14 },
  'Utilities / Infra-like (regolate)': { value:18, quality:15, growth:8, lev:15, strat:15, cash:15, roic:14 },
  'Telecom': { value:20, quality:12, growth:8, lev:20, strat:15, cash:15, roic:10 },
  'Media & Entertainment': { value:18, quality:15, growth:15, lev:15, strat:15, cash:12, roic:10 },
  'FinTech / Payments': { value:12, quality:18, growth:22, lev:8, strat:15, cash:10, roic:15 },
  'Hardware / Semiconductors': { value:15, quality:15, growth:18, lev:10, strat:15, cash:12, roic:15 }
};

const PRESET_TIPS = {
  'Neutrale': 'Balanced view for cross-sectional comparisons',
  'SaaS': 'Growth/quality recurring revenue > multiples; prudent leverage',
  'Software non-SaaS': 'More FCF vs SaaS, less "hyper" growth',
  'Industrial / Manufacturing': 'Cyclicality/physical assets → focus on price and leverage discipline',
  'Business Services (BPO, testing, facilities)': 'Defensible services, asset-light: quality/FCF/ROIC matter',
  'Healthcare – Providers/Services': 'Defensibility/regulation → quality and ROIC at center',
  'Healthcare – MedTech & Diagnostics': 'Defensible innovation; high ROIC and quality, low leverage',
  'Healthcare – CRO/CDMO': 'Structural growth + capital returns, good FCF',
  'Consumer Staples': 'Stability/recurrence → quality, FCF and price matter',
  'Consumer Discretionary/Retail': 'More cyclical: price and cash, but relevant growth',
  'Luxury & Premium Brands': 'Brand equity and pricing power: strong quality/FCF, high multiples',
  'Logistics & Transportation': 'Capital intensity/leverage; FCF and price drive returns',
  'Energy & Natural Resources (Upstream)': 'Commodity/volatility → price, leverage and jurisdiction',
  'Materials / Chemicals': 'Moderate cyclicality; mix/product strategy and ROIC',
  'Utilities / Infra-like (regolate)': 'Regulated/stable: fit/regulation, FCF/ROIC and price',
  'Telecom': 'High leverage, capex/FCF crucial, regulatory context',
  'Media & Entertainment': 'Demand volatility; price + fit (rights/markets)',
  'FinTech / Payments': 'Growth & quality + regulatory/partner barriers',
  'Hardware / Semiconductors': 'Technology cycles: growth/ROIC/fit, but watch capex'
};

const PRESET_RATIONALE = {
  'Neutrale': ['Balanced view for cross-sectional comparisons'],
  'SaaS': ['Growth/quality recurring revenue > multiples; prudent leverage'],
  'Software non-SaaS': ['More FCF vs SaaS, less "hyper" growth'],
  'Industrial / Manufacturing': ['Cyclicality/physical assets → focus on price and leverage discipline'],
  'Business Services (BPO, testing, facilities)': ['Defensible services, asset-light: quality/FCF/ROIC matter'],
  'Healthcare – Providers/Services': ['Defensibility/regulation → quality and ROIC at center'],
  'Healthcare – MedTech & Diagnostics': ['Defensible innovation; high ROIC and quality, low leverage'],
  'Healthcare – CRO/CDMO': ['Structural growth + capital returns, good FCF'],
  'Consumer Staples': ['Stability/recurrence → quality, FCF and price matter'],
  'Consumer Discretionary/Retail': ['More cyclical: price and cash, but relevant growth'],
  'Luxury & Premium Brands': ['Brand equity and pricing power; high quality/FCF and sustained ROIC'],
  'Logistics & Transportation': ['Capital intensity/leverage; FCF and price drive returns'],
  'Energy & Natural Resources (Upstream)': ['Commodity/volatility → price, leverage and jurisdiction'],
  'Materials / Chemicals': ['Moderate cyclicality; mix/product strategy and ROIC'],
  'Utilities / Infra-like (regolate)': ['Regulated/stable: fit/regulation, FCF/ROIC and price'],
  'Telecom': ['High leverage, capex/FCF crucial, regulatory context'],
  'Media & Entertainment': ['Demand volatility; price + fit (rights/markets)'],
  'FinTech / Payments': ['Growth & quality + regulatory/partner barriers'],
  'Hardware / Semiconductors': ['Technology cycles: growth/ROIC/fit, but watch capex']
};

// <!-- Value: sector-aware via dropdown -->
// Value: EV/EBITDA range per sector (labels IDENTICAL to dropdown)
const VALUE_WINSOR_BY_SECTOR = {
  'Neutrale (baseline)': [0, 30],
  'SaaS': [0, 40],
  'Software non-SaaS': [0, 35],
  'Industrial / Manufacturing': [0, 15],
  'Business Services (BPO, testing, facilities)': [0, 20],
  'Healthcare – Providers/Services': [0, 25],
  'Healthcare – MedTech & Diagnostics': [0, 25],
  'Healthcare – CRO/CDMO': [0, 25],
  'Consumer Staples': [0, 22],
  'Consumer Discretionary/Retail': [0, 25],
  'Luxury & Premium Brands': [0, 55],
  'Logistics & Transportation': [0, 14],
  'Energy & Natural Resources (Upstream)': [0, 10],
  'Materials / Chemicals': [0, 15],
  'Utilities / Infra-like (regolate)': [0, 18],
  'Telecom': [0, 12],
  'Media & Entertainment': [0, 25],
  'FinTech / Payments': [0, 35],
  'Hardware / Semiconductors': [0, 35],
  // fallback
  _default: [0, 30]
};

// New weight flow: use numeric inputs w* (0–1)
function readWeightsInputs(){
  const val = id => { const v=parseFloat(byId(id)?.value); return isFinite(v)? v : 0; };
  return {
    value: val('wValue'),
    quality: val('wQuality'),
    growth: val('wGrowth'),
    lev: val('wLev'),
    strat: val('wStrat'),
    cash: val('wCash'),
    roic: val('wROIC'),
    // Take-private: add ADV weight
    adv: val('wADV')
  };
}

// Maintain compatibility with previous storage (_slider in percentage)
function readSliderPerc(){
  const W = readWeightsInputs();
  return {
    value: Math.round((W.value||0)*100),
    quality: Math.round((W.quality||0)*100),
    growth: Math.round((W.growth||0)*100),
    lev: Math.round((W.lev||0)*100),
    strat: Math.round((W.strat||0)*100),
    cash: Math.round((W.cash||0)*100),
    roic: Math.round((W.roic||0)*100),
    // Take-private: include ADV in percentuali
    adv: Math.round((W.adv||0)*100)
  };
}

function setSliderPerc(W){
  // Convert percentages to fractions and set weight inputs
  if(W==null) return;
  const setFrac = (id,perc)=>{ const el=byId(id); if(!el) return; const f = (parseFloat(perc)||0)/100; el.value = f.toFixed(2); };
  setFrac('wValue', W.value);
  setFrac('wQuality', W.quality);
  setFrac('wGrowth', W.growth);
  setFrac('wLev', W.lev);
  setFrac('wStrat', W.strat);
  setFrac('wCash', W.cash);
  setFrac('wROIC', W.roic);
  // Take-private: default ADV 10% se non presente nel preset
  setFrac('wADV', (W.adv!=null? W.adv : 10));
}

// Funzione per pulire i pesi salvati dal localStorage
function clearSavedWeights(){
  const saved = JSON.parse(localStorage.getItem('pe-screener-5p-adv')||'{}');
  delete saved._slider;
  localStorage.setItem('pe-screener-5p-adv', JSON.stringify(saved));
}

// Pillar breakdown: accessible horizontal bars builder
function buildPillarBreakdown(scores, weights=null){
  const host = byId('pillarBreakdown'); if(!host) return;
  const ORDER = ['Value','Quality','Growth','Leverage','Cash Conversion','ROIC'];
  const tips = {
    'Value': 'EV/EBITDA: winsorized 0–30×; lower is better',
    'Quality': 'EBITDA margin: winsorized -50%–80%; higher is better',
    'Growth': 'CAGR 3Y: winsorized 0–40%; higher is better',
    'Leverage': 'Net Debt/EBITDA: winsorized 0–6×; lower is better',
    'Cash Conversion': 'FCF/EBITDA: winsorized 0–1; higher is better',
    'ROIC': 'ROIC: winsorized 0–20%; higher is better'
  };
  // Build entries in logical order, filtering missing ones, rounding 0–100
  const entries = ORDER
    .map(k=>[k, scores?.[k]])
    .filter(([,v])=> v!=null && isFinite(v))
    .map(([k,v])=>[k, Math.round(v*100)]);

  if(!entries.length){ host.innerHTML = '<div class="note">—</div>'; return; }

  // Weights: equal-weight by default; if provided, renormalize on present ones
  let W = {};
  if(weights && typeof weights==='object'){
    let sum = entries.reduce((acc,[k])=> acc + (weights[k]??0), 0);
    if(!(sum>0)){
      const eq = 100/entries.length; entries.forEach(([k])=> W[k]=eq);
    } else {
      entries.forEach(([k])=>{ W[k] = (weights[k]??0) * 100 / sum; });
    }
  } else {
    const eq = 100/entries.length; entries.forEach(([k])=> W[k]=eq);
  }

  // Optional sorting (currently off)
  const SORT_DESC = false;
  const data = SORT_DESC ? [...entries].sort((a,b)=> b[1]-a[1]) : entries;

  const html = data.map(([k,score])=>{
    const w = W[k]||0; const aria = `${k} score ${score} out of 100, weight ${w.toFixed(1)}%`;
    const tip = tips[k]||k;
    return `
      <div class="pb-row" aria-label="${aria}">
        <div class="pb-label" title="${tip}">${k}</div>
        <div class="pb-bar" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="${score}">
          <div class="pb-fill" style="width:${score}%"></div>
        </div>
        <div class="pb-meta">${score}/100 · (weight ${w.toFixed(1)}%)</div>
      </div>`;
  }).join('');

  host.innerHTML = html;
}

// New unified pillar breakdown from scoreModel.breakdown
function buildPillarBreakdownFrom(scoreModel){
  const host = byId('pillarBreakdown');
  if(!host) return;
  
  const items = (scoreModel?.breakdown || []).map(p => ({
    name: p.k,             // es. 'Value'
    score: Math.round(p.s*100), // 0–100
    w: Math.round(p.w*1000)/10  // es. 16.7
  }));
  
  if(!items.length){ 
    host.innerHTML = '<div class="note">—</div>'; 
    return; 
  }

  const tips = {
    'Value': 'EV/EBITDA: winsorized sector-aware; lower is better',
    'Quality': 'EBITDA margin: winsorized -50%–80%; higher is better',
    'Growth': 'CAGR 3Y: winsorized 0–40%; higher is better',
    'Leverage & Cash': 'Net Debt/EBITDA: winsorized 0–6×; lower is better',
    'Cash Conversion': 'FCF/EBITDA: winsorized 0–1; higher is better',
    'ROIC': 'ROIC: winsorized 0–20%; higher is better',
    'Strategic Fit': 'Sector/Country fit (0–1); higher is better',
    'Liquidity (ADV)': 'MC/ADV: winsorized 0–200; higher is better'
  };

  host.innerHTML = items.map(it => {
    const aria = `${it.name} score ${it.score} out of 100, weight ${it.w}%`;
    const tip = tips[it.name] || it.name;
    return `
      <div class="pb-row" aria-label="${aria}">
        <div class="pb-label" title="${tip}">${it.name}</div>
        <div class="pb-bar" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="${it.score}">
          <div class="pb-fill" style="width:${it.score}%"></div>
        </div>
        <div class="pb-meta">${it.score}/100 · (weight ${it.w}%)</div>
      </div>`;
  }).join('');
}

function applyPreset(name, opts = {}) {
  const { force = false } = opts;
  const alias = {
    'Industrial': 'Industrial / Manufacturing',
    'Business Services': 'Business Services (BPO, testing, facilities)',
    'Healthcare (Services, MedTech, CRO/CDMO)': 'Healthcare – Providers/Services',
    'Consumer Discretionary': 'Consumer Discretionary/Retail',
    'Logistics': 'Logistics & Transportation',
    'Energy/Natural Resources': 'Energy & Natural Resources (Upstream)',
    'Materials/Chemicals': 'Materials / Chemicals',
    'Utilities': 'Utilities / Infra-like (regolate)',
    'Media': 'Media & Entertainment',
    'FinTech/Payments': 'FinTech / Payments',
    'Hardware/Semiconductors': 'Hardware / Semiconductors'
  };
  const key = WEIGHT_PRESETS[name] ? name : (alias[name] || 'Neutrale');
  const preset = WEIGHT_PRESETS[key] || WEIGHT_PRESETS['Neutrale'];

  // Se chiamato da demo o cambio settore programmatico, forza preset
  if (force) {
    // Pulisce i pesi salvati se necessario
    clearSavedWeights();
    setSliderPerc(preset); // imposta i pesi (convertendo % -> frazione nei campi)
  } else {
    // Comportamento attuale: se c'è _slider coerente con lo stesso settore, ok;
    // se _preset salvato è diverso dal settore corrente, ignora _slider e usa preset
    const saved = JSON.parse(localStorage.getItem('pe-screener-5p-adv')||'{}');
    if (saved?._preset === key && saved?._slider) {
      setSliderPerc(saved._slider);
    } else {
      setSliderPerc(preset);
    }
  }

  // Sincronizza il selettore settore con la chiave effettiva
  const sel = byId('inSector');
  if (sel && sel.value !== key) {
    sel.value = key;
    // Dispatch dell'evento change per coerenza
    sel.dispatchEvent(new Event('change', { bubbles: true }));
  }

  // Ricalcolo UI
  const I = collectInput(); 
  const O = computeAll(I); 
  const S = score(O, I);
  gLast = { input: I, output: O, score: S };
  renderKPI(O, I, S);
  renderReport(O, I, S);
  renderAlerts(validate(I)); 
  saveState();
}

// <!-- Solidified Calcs: required utilities -->
// Solidified Calcs: formatMoney/formatPct mantengono i calcoli in numerico e formattano solo in render
const formatMoney = (n, ccy) => fmt(n, ccy);
const formatPct = (n) => pct(n);

// EV abbreviation for KPI card only
function formatEV_KPI(n, ccy){
  if(n == null || !isFinite(n)) return '—';
  const abs = Math.abs(n);
  let val, unit='';
  if(abs >= 1e12){ val = (n/1e12).toFixed(1); unit='trln'; }
  else if(abs >= 1e9){ val = (n/1e9).toFixed(1); unit='bln'; }
  else if(abs >= 1e6){ val = (n/1e6).toFixed(1); unit='mln'; }
  else { // < 1M: formato normale
    return new Intl.NumberFormat('it-IT').format(n);
  }
  return `${val} ${unit}`;
}

// <!-- Solidified Calcs: validazione input e pannello -->
function validate(input){
  const msgs = [];
  const hasMC = (input.marketCap!=null && input.marketCap>0);
  const hasPx = (input.price!=null && input.price>0);
  const hasSh = (input.shares!=null && input.shares>0);
  if(!hasMC && (!hasPx || !hasSh)) msgs.push('Price or Shares missing: Market Cap/EV not calculable.');
  if(!(input.ebitda>0)) msgs.push('EBITDA ≤ 0: multiples and leverage not meaningful.');
  if(!(input.rev[0]>0)) msgs.push('Revenue FY missing or ≤ 0: margin and CAGR not calculable.');
  if(input.rev[3]!=null && !(input.rev[3]>0)) msgs.push('Revenue FY-3 ≤ 0: CAGR not calculable.');
  if(input.nopat!=null && !(input.invCap>0)) msgs.push('Invested Capital ≤ 0 with NOPAT present: ROIC not calculable.');
  return msgs;
}

function renderAlerts(msgs){
  const panel = byId('alertsPanel');
  const list = byId('alertsList');
  if(!panel||!list) return;
  list.innerHTML = '';
  panel.classList.remove('ok','warn');
  if(!msgs.length){
    panel.classList.add('ok');
    list.innerHTML = '<li>No issues detected.</li>';
  } else {
    panel.classList.add('warn');
    list.innerHTML = msgs.map(m=>`<li>${m}</li>`).join('');
  }
}

function computeAll(input){
  const {price, shares, marketCap, debt, cash, rev, ebitda} = input;
  // Market Cap fallback
  const mc = (marketCap && marketCap>0) ? marketCap : (price>0 && shares>0 ? price*shares : null);
  // EV
  let ev = null; if(mc>0){ ev = mc + (debt||0) - (cash||0); if(!(ev>0)) ev = mc; }
  // EV/EBITDA
  const evE = (ev>0 && ebitda>0) ? ev/ebitda : null;
  // Margin
  const margin = (ebitda!=null && rev[0]>0) ? (ebitda/rev[0]) : null;
  // CAGR 3Y
  let cagr=null; if(rev[3]>0 && rev[0]>0) cagr = Math.pow(rev[0]/rev[3], 1/3)-1;
  // Net Debt
  const netDebt = (debt!=null || cash!=null) ? ((debt||0) - (cash||0)) : null;
  const ndE = (netDebt!=null && ebitda>0) ? netDebt/ebitda : null;
  const cashDebt = (debt>0 && cash!=null) ? cash/debt : (cash>0 && debt==0 ? 1.5 : null);
  // Cash Conversion & ROIC
  let fcf = null; if(input.ocf!=null && input.capex!=null){ fcf = input.ocf - input.capex; }
  const cashConv = (fcf!=null && ebitda>0) ? fcf / ebitda : null;
  const roic = (input.nopat!=null && input.invCap>0) ? input.nopat / input.invCap : null;
  return {mc, ev, evE, margin, cagr, netDebt, ndE, cashDebt, cashConv, roic};
}

function avgPresent(arr){
  const vals = arr.filter(v=>v!=null && isFinite(v));
  if(!vals.length) return null; return vals.reduce((a,b)=>a+b,0)/vals.length;
}

function score(output,input){
  const {evE, margin, cagr, ndE} = output;
  const W = input.weights;

  // Pillar primitives (normalized 0-1)
  // <!-- Value: sector-aware via dropdown -->
  // Value (sector-aware)
  const sectorLabel = input.sector; // già letto da collectInput() dal dropdown
  const [loV, hiV] = (VALUE_WINSOR_BY_SECTOR[sectorLabel] || VALUE_WINSOR_BY_SECTOR._default);
  const sValue   = evE==null? null : (1 - (winsor(evE, loV, hiV) / hiV)); // più basso meglio
  const sQuality = margin==null? null : (winsor(margin,-0.5,0.8)+0.5)/(0.8+0.5);
  const sGrowth  = cagr==null? null : winsor(cagr,0,0.40)/0.40;
  const sCash    = output.cashConv==null? null : winsor(output.cashConv,0,1);
  const sRoic    = output.roic==null? null : (winsor(output.roic,0,0.20)/0.20);

  // Leverage & Cash pillar
  const nd_w = ndE==null? null : 1 - (winsor(ndE,0,6)/6);
  const cd_w = output.cashDebt==null? null : winsor(output.cashDebt,0,1.5)/1.5;
  let sLev = null; if(nd_w!=null && cd_w!=null) sLev=(nd_w+cd_w)/2; else if(nd_w!=null) sLev=nd_w; else if(cd_w!=null) sLev=cd_w;

  // Strategic Fit pillar
  const sStrat = avgPresent([input.fit.sector, input.fit.country]);

  // Take-private: Liquidity (ADV) pillar
  let sADV = null;
  if(output.mc>0 && input.adv>0){
    const ratio = output.mc / input.adv; // MC/ADV
    const r01 = winsor(ratio, 0, 200) / 200; // normalizzato 0-1
    sADV = input.takePrivate ? r01 : (1 - r01);
  }

  const parts = [];
  if(sValue!=null)   parts.push({k:'Value',   w:W.value,   s:sValue});
  if(sQuality!=null) parts.push({k:'Quality', w:W.quality, s:sQuality});
  if(sGrowth!=null)  parts.push({k:'Growth',  w:W.growth,  s:sGrowth});
  if(sLev!=null)     parts.push({k:'Leverage & Cash', w:W.lev, s:sLev});
  if(sStrat!=null)   parts.push({k:'Strategic Fit',   w:W.strat, s:sStrat});
  if(sCash!=null)    parts.push({k:'Cash Conversion', w:W.cash, s:sCash});
  if(sRoic!=null)    parts.push({k:'ROIC', w:W.roic, s:sRoic});
  // Take-private: integra come 8° pilastro
  if(sADV!=null)     parts.push({k:'Liquidity (ADV)', w:W.adv, s:sADV});

  let wsum = parts.reduce((a,b)=>a+(b.w||0),0);
  if(wsum===0) return {score:null, breakdown:[], penalty:false, sizeFlag:false};
  parts.forEach(p=>p.w/=wsum);

  // Base score
  let scr = parts.reduce((a,b)=>a + b.w*b.s, 0);

  // Liquidity penalty (disattivata in modalità take-private)
  let penalty=false;
  if(!input.takePrivate && input.liq && input.adv!=null && input.adv<input.liq.thresh){ scr = scr*(1-input.liq.pen); penalty=true; }

  // Deal size mandate filter (Market Cap)
  let sizeFlag=false; const {min,max} = input.size;
  if(output.mc!=null && ((min && output.mc<min) || (max && output.mc>max))){ sizeFlag = true; scr = scr*0.7; }

  return {score:scr, breakdown:parts.map(p=>({...p, w:(p.w)})), penalty, sizeFlag};
}

function collectInput(){
  const num = id=>{ const raw = byId(id).value.trim(); if(raw==='') return null; const v=parseFloat(raw.replace(/,/g,'')); return isFinite(v)?v:null };
  const rev=[num('rev0'),num('rev1'),num('rev2'),num('rev3')];
  return {
    ticker: byId('inTicker').value.trim()||'',
    name: byId('inName').value.trim()||'',
    country: byId('inCountry').value.trim()||'',
    sector: byId('inSector').value.trim()||'',
    ccy: byId('inCcy').value,
    beta: num('inBeta'),
    price: num('inPrice'),
    shares: num('inShares'),
    marketCap: num('inMktCap'),
    debt: num('inDebt'),
    cash: num('inCash'),
    adv: num('inADV'),
    rev, // [FY, FY-1, FY-2, FY-3]
    ebitda: num('ebitda'),
    capex: num('capex'),
    ocf: num('ocf'),
    nopat: num('nopat'),
    invCap: num('invCap'),
    fy: parseInt(byId('fyYear').value)||null,
    // Weights from slider (in fraction 0-1)
    // Take-private: include ADV
    weights:(()=>{ const W = readSliderPerc(); return { value: W.value/100, quality: W.quality/100, growth: W.growth/100, lev: W.lev/100, strat: W.strat/100, cash: W.cash/100, roic: W.roic/100, adv: (W.adv||10)/100 }; })(),
    fit:{ sector: parseFloat(byId('fitSector').value), country: parseFloat(byId('fitCountry').value) },
    liq:{ thresh: parseFloat(byId('liqThresh').value)||0, pen: clamp(parseFloat(byId('liqPen').value)||0,0,1) },
    size:{ min: parseFloat(byId('sizeMin').value)||null, max: parseFloat(byId('sizeMax').value)||null },
    // Take-private: state toggle
    takePrivate: !!byId('takePrivateToggle')?.checked
  };
}

function renderKPI(output, input, scoreModel){
  const {ev, evE, margin, cagr, ndE} = output;
  
  // Helper function with guards
  const setTxt = (id, txt)=>{ const el=document.getElementById(id); if(el) el.textContent = txt; };

  // TOP HIGHLIGHTS
  setTxt('kTopEVEBITDA',  output.evE==null ? '—' : output.evE.toFixed(2)+'×');
  setTxt('kTopMargin',    formatPct(output.margin));
  setTxt('kTopROIC',      formatPct(output.roic));

  // SCORE highlight (numero grande coerente con progress bar)
  setTxt('kScoreText',    scoreModel.score==null ? '—' : (Math.round(scoreModel.score*100) + '/100'));
  const scoreBar = document.getElementById('scoreBar');
  if(scoreBar) scoreBar.style.width = (scoreModel.score==null?0: Math.round(scoreModel.score*100))+'%';
  setTxt('scoreNote',     scoreModel.score==null ? 'Score non calcolabile (dati insufficienti)' :
    `Score: ${(scoreModel.score*100).toFixed(0)} / 100 · Take-private: ${input.takePrivate?'ON':'OFF'}` + (scoreModel.penalty?' · penalità liquidità':'') + (scoreModel.sizeFlag?' · fuori mandato size':''));

  // SECOND ROW (no duplicates)
  // KPI card: EV abbreviato e tooltip con valore pieno
  const evFull = formatMoney(output.ev, input.ccy); // già esistente
  const evShort = formatEV_KPI(output.ev, input.ccy);
  const elEV = document.getElementById('kEV');
  if(elEV){
    elEV.textContent = evShort;           // es. "137.5 bln"
    elEV.parentElement?.setAttribute('title', evFull); // hover mostra numero completo
  }
  setTxt('kCcy',      input.ccy);
  setTxt('kCAGR',     formatPct(output.cagr));
  setTxt('kNDebtE',   output.ndE==null ? '—' : output.ndE.toFixed(2)+'×');
  setTxt('kCashConv', formatPct(output.cashConv));
  const mcadv = (output.mc>0 && input.adv>0)? (output.mc/input.adv) : null;
  setTxt('kMCADV',    mcadv==null ? '—' : mcadv.toFixed(1)+'×');

  // Pillar breakdown (visuale) - usa scoreModel.breakdown direttamente
  buildPillarBreakdownFrom(scoreModel);
}

function renderReport(output, input, scoreModel){
  const {ev, evE, margin, cagr, ndE} = output;
  
  const name = input.name || input.ticker || '—';
  const rows = [
    ['Ticker', input.ticker||'—'],
    ['Name', name],
    ['Country', input.country||'—'],
    ['Sector', input.sector||'—'],
    ['Currency', input.ccy],
    ['Price', formatMoney(input.price,input.ccy)],
    ['Shares', input.shares==null?'—': new Intl.NumberFormat('en-US').format(input.shares)],
    ['Market Cap', formatMoney((output.mc||input.marketCap),input.ccy)],
    ['Total Debt', formatMoney(input.debt,input.ccy)],
    ['Cash & Equivalents', formatMoney(input.cash,input.ccy)],
    ['EV', formatMoney(ev,input.ccy)],
    ['EV/EBITDA', evE==null?'—': evE.toFixed(2)+'×'],
    ['EBITDA Margin', formatPct(margin)],
    ['Rev CAGR 3Y', formatPct(cagr)],
    ['Net Debt / EBITDA', output.ndE==null?'—': output.ndE.toFixed(2)+'×'],
    ['Cash / Debt', output.cashDebt==null?'—': output.cashDebt.toFixed(2)+'×'],
    ['Cash Conversion', formatPct(output.cashConv)],
    ['ROIC', formatPct(output.roic)],
    ['ADV 60d (ccy)', formatMoney(input.adv,input.ccy)],
    // Take-private: state
    ['Take-private', input.takePrivate? 'ON' : 'OFF'],
    ['Beta', input.beta==null?'—': input.beta.toFixed(2)],
    ['Latest FY', input.fy||'—'],
    ['Strategic Fit – Sector', (isFinite(input.fit.sector)? (input.fit.sector.toFixed(2)) : '—')],
    ['Strategic Fit – Country', (isFinite(input.fit.country)? (input.fit.country.toFixed(2)) : '—')],
    ['Deal size range (MC)', `${formatMoney(input.size.min,input.ccy)} – ${formatMoney(input.size.max,input.ccy)}`]
  ];

  const tb = [`<table><thead><tr><th>Item</th><th>Value</th></tr></thead><tbody>`,
    ...rows.map(r=>`<tr><td>${r[0]}</td><td>${r[1]}</td></tr>`),
    `</tbody></table>`].join('');

  const revTbl = `<table><thead><tr><th>Year</th><th>Revenue</th></tr></thead><tbody>
    <tr><td>${(input.fy||'FY')}</td><td>${formatMoney(input.rev[0],input.ccy)}</td></tr>
    <tr><td>${(input.fy?input.fy-1:'FY-1')}</td><td>${formatMoney(input.rev[1],input.ccy)}</td></tr>
    <tr><td>${(input.fy?input.fy-2:'FY-2')}</td><td>${formatMoney(input.rev[2],input.ccy)}</td></tr>
    <tr><td>${(input.fy?input.fy-3:'FY-3')}</td><td>${formatMoney(input.rev[3],input.ccy)}</td></tr>
  </tbody></table>`;

  // Genera il blocco "Pillars" del Report dagli stessi dati di scoreModel.breakdown
  const pillarRows = (scoreModel.breakdown || []).map(p =>
    `<li><b>${p.k}</b>: score ${(p.s*100|0)}/100 · weight ${(p.w*100).toFixed(1)}%</li>`).join('');
  const reportPillars = `
    <h3>Pillars – ${ (scoreModel.breakdown||[]).map(p=>p.k).join(' / ') }</h3>
    <ul class="note">${ pillarRows || '<li>—</li>' }</ul>
    <p class="note">EV/EBITDA range is sector-aware; hover the EV/EBITDA KPI to see the current range.</p>`;

  const execHtml = `
    <div class="card" style="background:#0e1520;border-color:var(--border,#1a2330)">
      <h2>Executive Summary</h2>
      <p><b>${name}</b> (${input.ticker||'N/A'}) – ${input.country||'N/A'} · ${input.sector||'N/A'} · currency ${input.ccy}. EV ${formatMoney(ev,input.ccy)}, EV/EBITDA ${(evE==null?'n.a.':evE.toFixed(2)+'×')}, EBITDA margin ${formatPct(margin)}, 3Y revenue growth ${formatPct(cagr)}, Net Debt/EBITDA ${(output.ndE==null?'n.a.':output.ndE.toFixed(2)+'×')}, Cash Conversion ${formatPct(output.cashConv)}, ROIC ${formatPct(output.roic)}.</p>
      <p class="note">Total score ${(scoreModel.score==null?'—':(scoreModel.score*100).toFixed(0)+'/100')} · Take-private ${input.takePrivate?'ON':'OFF'}${scoreModel.penalty?' · liquidity penalty':''}${scoreModel.sizeFlag?' · outside size mandate':''}.</p>
      ${input.takePrivate? '<p class="note"><b>Take-private mode active:</b> Low ADV rewarded.</p>' : ''}
    </div>`;

  const kpiHtml = `
    <div class="grid two" style="gap:18px">
      <div class="card"> <h2>Data & KPI</h2> ${tb} </div>
      <div class="card"> <h2>Revenue History</h2> ${revTbl}
        <p class="note">Rev CAGR 3Y calculated on FY and FY-3 (if both > 0).</p>
      </div>
    </div>`;

  const pillarsHtml = `
    <div class="card">
      ${reportPillars}
      <ul class="note" style="margin-top:8px">
        <li>Value: Lower EV/EBITDA ⇒ higher score (sector-aware winsorization).</li>
        <li>Quality: EBITDA% winsorized [-50%, 80%].</li>
        <li>Growth: CAGR 3Y winsorized 0–40%.</li>
        <li>Leverage & Cash: Lower Net Debt/EBITDA and higher Cash/Debt are better (winsorized 0–6 and 0–1.5).</li>
        <li>Cash Conversion: FCF/EBITDA (winsorized 0–1) – higher is better.</li>
        <li>ROIC: NOPAT/Invested Capital (winsorized 0–20%) – higher is better.</li>
        <li>Strategic Fit: average of sector/country fit (0–1) entered by user.</li>
        <li>Liquidity (ADV): uses MC/ADV (winsorized 0–200). Mode ${input.takePrivate?'bonus (low ADV rewarded)':'penalty (low ADV penalized)'}.</li>
      </ul>
    </div>`;

  const detailsHtml = `
    <div class="card"> <h2>Data & KPI (complete)</h2> ${tb} </div>
    <div class="card"> <h2>Outlier & Note</h2> <div class="note">${byId('outliersBox')?.innerHTML||'—'}</div> </div>`;

  const tabExec = byId('tabExec'); if(tabExec) tabExec.innerHTML = execHtml;
  const tabKPI = byId('tabKPI'); if(tabKPI) tabKPI.innerHTML = kpiHtml;
  const tabP = byId('tabPillars'); if(tabP) tabP.innerHTML = pillarsHtml;
  const tabD = byId('tabDetails'); if(tabD) tabD.innerHTML = detailsHtml;

  // <!-- Value: sector-aware via dropdown -->
  // Warning/outlier consistent with sector range (high EV/EBITDA relative to cap)
  {
    const out = byId('outliersBox');
    if(out){
      const warns = [];
      const r = (VALUE_WINSOR_BY_SECTOR[input.sector] || VALUE_WINSOR_BY_SECTOR._default);
      const hiV = r && r[1];
      if (output.evE!=null && hiV && output.evE > 0.85*hiV) {
        warns.push(`EV/EBITDA high relative to sector range (${output.evE.toFixed(1)}× > 85% of ${hiV}×)`);
      }
      out.innerHTML = warns.length? (`<ul>${warns.map(w=>`<li>${w}</li>`).join('')}</ul>`) : '—';
    }
  }

  byId('stamp').textContent = `Generated: ${new Date().toLocaleString('en-US')} · Local tool without backend`;
}

// ---------- Persistence (localStorage) ----------
function saveState(){
  const I = collectInput();
  const slider = readSliderPerc();
  const presetKey = (byId('inSector')?.value)||'Neutrale';
  const payload = {...I, _slider: slider, _preset: presetKey};
  localStorage.setItem('pe-screener-5p-adv', JSON.stringify(payload));
}
function loadState(){ try{ const o=JSON.parse(localStorage.getItem('pe-screener-5p-adv')||'{}'); if(!o||!Object.keys(o).length) return; setInputs(o);}catch(_){} }
function setInputs(o){
  const set=(id,val)=>{ if(val==null||val==='') return; const el=byId(id); if(!el) return; el.value=val; };
  set('inTicker',o.ticker); set('inName',o.name); set('inCountry',o.country); set('inSector',o.sector); set('inCcy',o.ccy); set('inBeta',o.beta);
  set('inPrice',o.price); set('inShares',o.shares); set('inMktCap',o.marketCap); set('inDebt',o.debt); set('inCash',o.cash); set('inADV',o.adv);
  set('rev0',o.rev?.[0]); set('rev1',o.rev?.[1]); set('rev2',o.rev?.[2]); set('rev3',o.rev?.[3]); set('ebitda',o.ebitda); set('fyYear',o.fy);
  set('capex',o.capex); set('ocf',o.ocf); set('nopat',o.nopat); set('invCap',o.invCap);
  // Slider percentages and legacy input synchronization 0-1
  if(o._slider){ setSliderPerc(o._slider); }
  else if(o.weights){
    setSliderPerc({
      value: Math.round((o.weights.value||0)*100),
      quality: Math.round((o.weights.quality||0)*100),
      growth: Math.round((o.weights.growth||0)*100),
      lev: Math.round((o.weights.lev||0)*100),
      strat: Math.round((o.weights.strat||0)*100),
      cash: Math.round((o.weights.cash||0)*100),
      roic: Math.round((o.weights.roic||0)*100),
      // Take-private: also recover ADV if present
      adv: Math.round((o.weights.adv!=null?o.weights.adv:0.10)*100)
    });
  }
  const Wperc = readSliderPerc();
  set('wValue', (Wperc.value/100).toFixed(2)); set('wQuality',(Wperc.quality/100).toFixed(2)); set('wGrowth',(Wperc.growth/100).toFixed(2)); set('wLev',(Wperc.lev/100).toFixed(2)); set('wStrat',(Wperc.strat/100).toFixed(2)); set('wCash',(Wperc.cash/100).toFixed(2)); set('wROIC',(Wperc.roic/100).toFixed(2)); set('wADV', (Wperc.adv/100).toFixed(2));
  set('fitSector',o.fit?.sector); set('fitCountry',o.fit?.country);
  set('liqThresh',o.liq?.thresh); set('liqPen',o.liq?.pen);
  set('sizeMin',o.size?.min); set('sizeMax',o.size?.max);
  if(o._preset){ set('inSector', o._preset); }
  // Take-private: restore toggle
  const tgl = byId('takePrivateToggle'); if(tgl && typeof o.takePrivate==='boolean'){ tgl.checked = o.takePrivate; }
}

// ---------- Sample ----------
function loadSample(){
  setInputs({
    ticker:'SAP.DE', name:'SAP SE', country:'Germany', sector:'Software non-SaaS', ccy:'EUR', beta:1.05,
    price:140.5, shares:1180000000, marketCap:'', debt:18000000000, cash:6000000000, adv: 35000000,
    rev:[32100000000, 30800000000, 27900000000, 27300000000], ebitda:17800000000, fy:2024,
    capex:2000000000, ocf:15000000000, nopat:9000000000, invCap:45000000000,
    // Take-private: add ADV weight default 0.10
    weights:{value:0.25,quality:0.20,growth:0.20,lev:0.20,strat:0.15,cash:0.10,roic:0.10,adv:0.10},
    fit:{sector:0.9,country:0.8}, liq:{thresh:2000000, pen:0.15}, size:{min:1e9,max:2e11}
  });
}

// ---------- Events ----------
// Tabs handler (once only)
(function initTabs(){
  const bar = byId('reportTabs');
  if(!bar) return;
  bar.addEventListener('click', (e)=>{
    const b = e.target.closest('button[data-tab]'); if(!b) return;
    const sel = b.dataset.tab;
    [...bar.querySelectorAll('button')].forEach(x=>x.classList.toggle('active', x===b));
    [...document.querySelectorAll('#reportSection .tabc')].forEach(p=>p.hidden = (p.id!==sel));
  });
})();

// Subnav active section highlighting (dynamic rootMargin)
(function initSubnavActive(){
  const links=[...document.querySelectorAll('#subnav a')];
  if(!links.length) return;
  const targets=links.map(a=>document.querySelector(a.getAttribute('href'))).filter(Boolean);
  if(!targets.length) return;

  let obs=null;
  const updateObserver = ()=>{
    const cs = getComputedStyle(document.documentElement);
    const th = parseInt(cs.getPropertyValue('--h-topnav')) || 48;
    const hh = parseInt(cs.getPropertyValue('--h-header')) || 56;
    const nh = parseInt(cs.getPropertyValue('--h-subnav')) || 44;
    if(obs) obs.disconnect();
    obs = new IntersectionObserver((entries)=>{
      entries.forEach(e=>{
        if(e.isIntersecting){
          const id='#'+e.target.id;
          links.forEach(l=>l.classList.toggle('active', l.getAttribute('href')===id));
        }
      });
    },{ rootMargin: `-${th+hh+nh+20}px 0px -60% 0px`, threshold:[0,1] });
    targets.forEach(t=>obs.observe(t));
  };

  updateObserver();
  window.addEventListener('resize', updateObserver);
})();

// Top-nav marketing: active section highlighting + smooth anchors
function initTopNav(){
  const bar = document.querySelector('.marketing-nav');
  if(!bar) return;
  const links=[...bar.querySelectorAll('a[href^="#"]')];
  const ids=['#home','#how','#features','#demo','#faq','#contact'];
  const targets = ids.map(id=>document.querySelector(id)).filter(Boolean);
  if(!targets.length) return;

  // Smooth scroll (in addition to CSS)
  links.forEach(a=>{
    a.addEventListener('click', (e)=>{
      const href=a.getAttribute('href');
      if(href && href.startsWith('#')){
        const tgt=document.querySelector(href);
        if(tgt){ e.preventDefault(); tgt.scrollIntoView({behavior:'smooth', block:'start'}); }
      }
    });
  });

  let obs=null;
  const updateObserver=()=>{
    const cs=getComputedStyle(document.documentElement);
    const th=parseInt(cs.getPropertyValue('--h-topnav'))||48;
    if(obs) obs.disconnect();
    obs=new IntersectionObserver((entries)=>{
      entries.forEach(e=>{
        if(e.isIntersecting){
          const id='#'+e.target.id;
          links.forEach(l=>l.classList.toggle('active', l.getAttribute('href')===id));
        }
      });
    },{ rootMargin:`-${th+10}px 0px -60% 0px`, threshold:[0,1] });
    targets.forEach(t=>obs.observe(t));
  };
  updateObserver();
  window.addEventListener('resize', updateObserver);
}
byId('btnCalc').addEventListener('click',()=>{ 
  const I = collectInput();
  const O = computeAll(I);
  const S = score(O, I);
  gLast = { input: I, output: O, score: S };
  renderKPI(O, I, S);
  renderReport(O, I, S);
  renderAlerts(validate(I));
  saveState();
});
byId('btnSave').addEventListener('click',()=>{ saveState(); alert('Saved locally.'); });
byId('btnLoad').addEventListener('click',()=>{ 
  loadState(); 
  const I = collectInput(); 
  const O = computeAll(I); 
  const S = score(O, I);
  gLast = { input: I, output: O, score: S };
  renderKPI(O, I, S);
  renderReport(O, I, S);
  renderAlerts(validate(I)); 
});
byId('btnPrint').addEventListener('click', runPrint);

// Solidified Calcs: rerender on currency change
byId('inCcy').addEventListener('change',()=>{ 
  const I = collectInput(); 
  const O = computeAll(I); 
  const S = score(O, I);
  gLast = { input: I, output: O, score: S };
  renderKPI(O, I, S);
  renderReport(O, I, S);
  renderAlerts(validate(I)); 
  saveState(); 
});

// Preset & Slider events
;['wValue','wQuality','wGrowth','wLev','wStrat','wCash','wROIC'].forEach(id=>{
  const el = byId(id); if(el){ 
    el.addEventListener('input',()=>{ 
      const I = collectInput(); 
      const O = computeAll(I); 
      const S = score(O, I);
      gLast = { input: I, output: O, score: S };
      renderKPI(O, I, S);
      renderReport(O, I, S);
      renderAlerts(validate(I)); 
      saveState(); 
    }); 
  }
});
const presetSel = byId('inSector'); if(presetSel){ presetSel.addEventListener('change',(e)=>{ applyPreset(e.target.value); }); }
// Take-private: UI events (toggle + new weight)
const tgl = byId('takePrivateToggle'); if(tgl){ 
  tgl.addEventListener('change',()=>{ 
    const I = collectInput(); 
    const O = computeAll(I); 
    const S = score(O, I);
    gLast = { input: I, output: O, score: S };
    renderKPI(O, I, S);
    renderReport(O, I, S);
    renderAlerts(validate(I)); 
    saveState(); 
  }); 
}
const wADV = byId('wADV'); if(wADV){ 
  wADV.addEventListener('input',()=>{ 
    const I = collectInput(); 
    const O = computeAll(I); 
    const S = score(O, I);
    gLast = { input: I, output: O, score: S };
    renderKPI(O, I, S);
    renderReport(O, I, S);
    renderAlerts(validate(I)); 
    saveState(); 
  }); 
}

// init
loadState();
// Theme after loading state (doesn't interfere with @media print)
initTheme();
// Sticky offsets: init + observers on header/subnav
window.addEventListener('load', setStickyVars);
window.addEventListener('resize', setStickyVars);
const __ro = new ResizeObserver(setStickyVars);
const __hdr = document.querySelector('header'); if(__hdr) __ro.observe(__hdr);
const __nav = document.getElementById('subnav'); if(__nav) __ro.observe(__nav);
const __top = document.querySelector('.marketing-nav'); if(__top) __ro.observe(__top);
// Initialize: if saved weights exist, use those; otherwise apply preset from sector list
try{
  const saved = JSON.parse(localStorage.getItem('pe-screener-5p-adv')||'{}');
  const currentSector = (byId('inSector')?.value)||'Neutrale';
  
  // Se lo stato salvato ha _preset diverso dal settore corrente, non applicare _slider salvato
  if(saved && saved._slider && saved._preset === currentSector){ 
    setSliderPerc(saved._slider); 
    const I = collectInput(); 
    const O = computeAll(I); 
    const S = score(O, I);
    gLast = { input: I, output: O, score: S };
    renderKPI(O, I, S);
    renderReport(O, I, S);
    renderAlerts(validate(I)); 
  }
  else { applyPreset(currentSector); }
}catch(_){ applyPreset('Neutrale'); }
// Demo dropdown init (after DOM ready and preset):
initDemoDropdown();
// Marketing nav init
initTopNav();
// CTA Hero: print example
const _heroPrint = document.getElementById('btnHeroPrint'); if(_heroPrint){ _heroPrint.addEventListener('click',(e)=>{ e.preventDefault(); runPrint(); }); }

// Mark active navigation link
(function markActive(){
  const links = document.querySelectorAll('nav .menu a[href^="#"]');
  function sync(){
    const hash = location.hash || '#home';
    links.forEach(a => a.setAttribute('aria-current', a.getAttribute('href')===hash ? 'page' : null));
  }
  window.addEventListener('hashchange', sync, { passive:true });
  sync();
})();

// ---------- Unified Print Pipeline ----------
function getSelectedPrintMode(){
  const el = document.querySelector('input[name="printMode"]:checked');
  const v = (el?.value || '').toLowerCase();
  return v === 'fullmemo' ? 'fullmemo' : 'executive';
}

function preparePrint(){
  // 1) Validazione
  if (!gLast?.input || !gLast?.output || !gLast?.score){
    alert('Generate report first (KPI & Score) before printing.');
    throw new Error('Missing gLast data');
  }
  // 2) Popola contenuto
  const mode = getSelectedPrintMode();
  const el = document.getElementById('printReport');
  if (!el) throw new Error('#printReport not found');
  // pulizia preventiva
  el.innerHTML = '';
  // costruisci SOLO dentro #printReport
  buildPrintReport(gLast, mode);
  // 3) Monta in fondo al body per isolamento layout
  if (el.parentElement !== document.body) {
    document.body.appendChild(el);
  } else {
    // anche se è già nel body, spostalo in coda
    document.body.appendChild(el);
  }
  // 4) Mostra il contenitore nel flusso
  el.classList.add('print-only-active');
  el.setAttribute('aria-hidden','false');
  // 5) Sanity check: HTML non vuoto
  if(!el.innerHTML.trim()){
    throw new Error('Empty printReport');
  }
}

function cleanupPrint(){
  const el = document.getElementById('printReport');
  if(!el) return;
  el.classList.remove('print-only-active');
  el.setAttribute('aria-hidden','true');
  el.innerHTML = '';
}

function runPrint(){
  console.debug('Print mode:', getSelectedPrintMode(), 'gLast?', !!(gLast?.input && gLast?.output && gLast?.score));
  try{
    preparePrint();
    const after = ()=>{
      cleanupPrint();
      window.removeEventListener('afterprint', after);
      window.onafterprint = null;
    };
    if ('onafterprint' in window){
      window.onafterprint = after;
    }else{
      window.addEventListener('afterprint', after);
    }
    window.print();
  }catch(e){
    console.error('Print aborted:', e);
  }
}
</script>
</body>
</html>